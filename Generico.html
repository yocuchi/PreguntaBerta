<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titulo</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748', // Custom lighter gray for inputs/cards
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS Bundle removed as we don't need it for Tailwind, but some logic might rely on it? 
         Logic relies on $().modal(), which is Bootstrap. I need to replace modal logic. 
         I will remove Bootstrap JS and implement a simple custom modal function. -->
    <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script> -->
    
    <style>
        .star {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            border-radius: 50%;
            animation: starFade 1.5s ease-out forwards;
        }
        
        @keyframes starFade {
            0% {
                opacity: 1;
                transform: scale(0) translateY(0);
            }
            50% {
                opacity: 0.8;
                transform: scale(1) translateY(-20px);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) translateY(-40px);
            }
        }
        
        .star-trail {
            position: fixed;
            pointer-events: none;
            z-index: 9998;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(147, 197, 253, 0.6) 50%, rgba(139, 92, 246, 0.3) 100%);
            box-shadow: 0 0 10px rgba(147, 197, 253, 0.8), 0 0 20px rgba(139, 92, 246, 0.5);
            animation: trailFade 0.8s ease-out forwards;
        }
        
        @keyframes trailFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }
    </style>

    <script>
        // Cargar el juego din√°micamente basado en el querystring
        function cargarJuego() {
            const urlParams = new URLSearchParams(window.location.search);
            const juegoId = urlParams.get('juego') || '2Pri-Ingles'; // Si no hay juego, usar 2Pri-Ingles por defecto
            
            // Actualizar juegoActual globalmente
            juegoActual = juegoId;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = `games/${juegoId}.js`;
                script.onload = () => {
                    // Verificar que preguntasJSON se haya cargado correctamente
                    if (typeof preguntasJSON === 'undefined' || !preguntasJSON) {
                        reject(new Error('preguntasJSON no se carg√≥ correctamente'));
                        return;
                    }

                    // Una vez cargado el script del juego, leemos sus variables globales
                    tipoDeJuegoActual = tipoJuego || "normal"; // Asumiendo que tipoJuego est√° definido en el archivo JS del juego
                    esCaseSensitive = typeof caseSensitive !== 'undefined' ? caseSensitive : false;

                    // Solo cargar configuraciones espec√≠ficas si es juego de tabla peri√≥dica
                    if (tipoDeJuegoActual === "tablaPeriodica") {
                        configActualTablaPeriodica = configuracionTablaPeriodica || {};
                        columnasJuegoActual = columnasDisponibles || [];
                        valenciasJuegoActual = todasLasValenciasPosibles || [];

                        // Modificar preguntasJSON para tabla peri√≥dica si es necesario
                        if (!configActualTablaPeriodica.preguntarValenciasComoSimbolo) {
                            preguntasJSON.forEach(elemento => {
                                elemento.valenciasOriginales = elemento.valencias; // Guardar originales por si acaso
                                elemento.valencias = [...new Set(elemento.valencias.replace(/[\\+\\-]/g, '').split(' ').map(v => v.trim()).filter(v => v.length > 0))].join(' ');
                            });
                            valenciasJuegoActual = [...new Set(valenciasJuegoActual.map(v => v.replace(/[\\+\\-]/g, '')))].sort((a,b) => parseInt(a) - parseInt(b));
                        }
                    } else {
                        // Para juegos normales, inicializar variables vac√≠as para evitar errores
                        configActualTablaPeriodica = {};
                        columnasJuegoActual = [];
                        valenciasJuegoActual = [];
                    }

                    console.log("Tipo de juego cargado:", tipoDeJuegoActual);
                    console.log("preguntasJSON cargado con", preguntasJSON.length, "preguntas");
                    resolve();
                };
                script.onerror = () => {
                    reject(new Error('Error al cargar el archivo del juego'));
                };
                document.head.appendChild(script);
            });
        }
    </script>

    <script>
        // Registra el Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

    <script>
        let resultados = []; // Se inicializar√° en el load
        let palabraActual;
        let totalPreguntas = 0;
        let numeroTotalPreguntas = 10;
        let palabrasUsadas = [];
        let aciertosTotales = 0;
        let juegoActual = window.juegoActual || '2Pri-Ingles';
        let modoJuego = 'surtido'; // 'surtido' o 'todas'
        
        // Variables para el tipo de juego y configuraci√≥n espec√≠fica
        let tipoDeJuegoActual = ""; // Se establecer√° en cargarJuego
        let esCaseSensitive = false; // Se establecer√° en cargarJuego, por defecto false
        let configActualTablaPeriodica = {}; // Se llenar√° desde el JS del juego si es tablaPeriodica
        let columnasJuegoActual = []; // Para tablaPeriodica
        let valenciasJuegoActual = []; // Para tablaPeriodica

        // Funciones para manejar cookies
        function getCookie(nombre) {
            let nombreCookie = `${nombre}=`;
            let decodedCookie = decodeURIComponent(document.cookie);
            let cookiesArray = decodedCookie.split(';');
            for (let i = 0; i < cookiesArray.length; i++) {
                let cookie = cookiesArray[i].trim();
                if (cookie.indexOf(nombreCookie) === 0) {
                    return cookie.substring(nombreCookie.length, cookie.length);
                }
            }
            return "";
        }

        function setCookie(nombre, valor, dias = 365) {
            // Cookie con fecha de expiraci√≥n para persistencia
            const fecha = new Date();
            fecha.setTime(fecha.getTime() + (dias * 24 * 60 * 60 * 1000));
            const expira = "expires=" + fecha.toUTCString();
            document.cookie = `${nombre}=${valor}; ${expira}; path=/; SameSite=Lax`;
        }

        // Cargar usuario desde cookie
        let usuarioActual = getCookie("usuarioActual");

        // Modificar la gesti√≥n de resultados para ser espec√≠fica por juego
        function cargarResultados() {
            console.log('Cargando resultados para juego:', juegoActual);
            // Usar una clave espec√≠fica para cada juego
            const claveStorage = `resultados_${juegoActual}`;
            resultados = JSON.parse(localStorage.getItem(claveStorage)) || [];
            console.log('Resultados cargados:', resultados);
            return resultados;
        }

        function guardarResultados(nuevosResultados) {
            console.log('Guardando resultados para juego:', juegoActual);
            // Usar una clave espec√≠fica para cada juego
            const claveStorage = `resultados_${juegoActual}`;
            localStorage.setItem(claveStorage, JSON.stringify(nuevosResultados));
            console.log('Resultados guardados:', nuevosResultados);
        }

        function mostrarModalNombre() {
            const modal = $(`
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4" id="modal-nombre">
                    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" id="modal-nombre-backdrop"></div>
                    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md z-10 border border-gray-700 transform transition-all">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold text-white mb-4 text-center">üëã ¬°Bienvenido!</h3>
                            <p class="text-gray-300 mb-4 text-center">Por favor, ingresa tu nombre para comenzar:</p>
                            <input type="text" id="input-nombre" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none mb-4" placeholder="Tu nombre" autofocus>
                            <button id="btn-confirmar-nombre" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-lg">
                                Continuar
                            </button>
                        </div>
                    </div>
                </div>
            `);
            
            $('body').append(modal);
            $('#input-nombre').focus();
            
            const cerrarModal = () => {
                $('#modal-nombre').fadeOut(200, function() { $(this).remove(); });
            };
            
            $('#btn-confirmar-nombre').on('click', function() {
                const nombre = $('#input-nombre').val().trim();
                if (nombre) {
                    usuarioActual = nombre;
                    setCookie('usuarioActual', usuarioActual);
                    actualizarNombreUsuario();
                    cerrarModal();
                    mostrarConfiguracion();
                } else {
                    $('#input-nombre').addClass('border-red-500');
                    setTimeout(() => $('#input-nombre').removeClass('border-red-500'), 1000);
                }
            });
            
            $('#input-nombre').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#btn-confirmar-nombre').click();
                }
            });
            
            $('#modal-nombre-backdrop').on('click', function() {
                // No permitir cerrar sin nombre
                const nombre = $('#input-nombre').val().trim();
                if (!nombre) {
                    $('#input-nombre').addClass('border-red-500');
                    setTimeout(() => $('#input-nombre').removeClass('border-red-500'), 1000);
                }
            });
        }

        function actualizarNombreUsuario() {
            // Establecer t√≠tulo inicial sin contador de preguntas
            document.title = `Quiz - ${usuarioActual}`;
            $('h1#titulo').text(`Bienvenido ${usuarioActual}`);
            actualizarFotoUsuario();
        }

        function preguntarNombre() {
            if (!usuarioActual) {
                mostrarModalNombre();
            } else {
                actualizarNombreUsuario();
                mostrarConfiguracion();
            }
        }

        function generarVersionImprimible() {
            // Crear el HTML para la versi√≥n imprimible
            let htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${tituloJuego} - Versi√≥n para Imprimir</title>
    <style>
        @page {
            size: A4;
            margin: 1cm;
        }
        @media print {
            body { margin: 0; padding: 0; }
            .no-print { display: none; }
            .page-break { page-break-after: always; }
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            margin: 0;
            padding: 10px;
            line-height: 1.3;
        }
        h1 {
            font-size: 14pt;
            color: #333;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 5px;
            margin: 0 0 8px 0;
            text-align: center;
        }
        .info {
            font-size: 8pt;
            text-align: center;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #f3f4f6;
        }
        .info p {
            margin: 2px 0;
        }
        .preguntas-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            column-gap: 12px;
        }
        .pregunta {
            margin-bottom: 8px;
            padding: 6px;
            border: 1px solid #ddd;
            border-left: 3px solid #3b82f6;
            background-color: #fff;
            page-break-inside: avoid;
            min-height: 40px;
        }
        .pregunta-numero {
            font-weight: bold;
            color: #3b82f6;
            font-size: 9pt;
            margin-bottom: 4px;
        }
        .pregunta-texto {
            font-size: 9pt;
            margin-bottom: 8px;
            line-height: 1.2;
        }
        .espacio-respuesta {
            border-bottom: 1px dotted #999;
            min-height: 20px;
            margin-top: 8px;
        }
        .tabla-periodica {
            margin-top: 5px;
            font-size: 8pt;
        }
        .tabla-periodica table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }
        .tabla-periodica td {
            padding: 3px;
            border: 1px solid #ddd;
            font-size: 8pt;
        }
        .tabla-periodica td:first-child {
            font-weight: bold;
            background-color: #e0e7ff;
            width: 35%;
        }
        .tabla-periodica .espacio-respuesta {
            min-height: 15px;
        }
        .no-print {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #fef3c7;
            border-radius: 5px;
        }
        .no-print button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        .no-print button:hover {
            background-color: #2563eb;
        }
        @media print {
            .no-print { display: none; }
            .preguntas-container {
                gap: 6px;
                column-gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="no-print">
        <p><strong>Versi√≥n para imprimir de: ${tituloJuego}</strong></p>
        <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button onclick="window.close()">‚ùå Cerrar</button>
    </div>
    
    <h1>${tituloJuego}</h1>
    
    <div class="info">
        <p><strong>Curso:</strong> ${curso || 'N/A'} | <strong>Total:</strong> ${preguntasJSON.length} preguntas | <strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
    </div>
    
    <div class="preguntas-container">
`;

            // Generar las preguntas sin respuestas
            preguntasJSON.forEach((pregunta, index) => {
                htmlContent += `
        <div class="pregunta">
            <div class="pregunta-numero">${index + 1}.</div>`;

                if (tipoDeJuegoActual === "tablaPeriodica") {
                    // Formato para tabla peri√≥dica sin respuestas
                    htmlContent += `
            <div class="pregunta-texto">${prefijoPregunta}<strong>${pregunta.nombre}</strong>${sufijoPregunta}</div>
            <div class="tabla-periodica">
                <table>
                    <tr>
                        <td>S√≠mbolo:</td>
                        <td><div class="espacio-respuesta"></div></td>
                    </tr>
                    <tr>
                        <td>Columna:</td>
                        <td><div class="espacio-respuesta"></div></td>
                    </tr>
                    <tr>
                        <td>Valencias:</td>
                        <td><div class="espacio-respuesta"></div></td>
                    </tr>
                </table>
            </div>`;
                } else {
                    // Formato para preguntas normales sin respuestas
                    htmlContent += `
            <div class="pregunta-texto">${prefijoPregunta}<strong>"${pregunta.nombre}"</strong>${sufijoPregunta}</div>
            <div class="espacio-respuesta"></div>`;
                }

                htmlContent += `
        </div>`;
            });

            htmlContent += `
    </div>
</body>
</html>`;

            // Abrir una nueva ventana con el HTML generado
            const ventanaImpresion = window.open('', '_blank', 'width=800,height=600');
            if (ventanaImpresion) {
                ventanaImpresion.document.write(htmlContent);
                ventanaImpresion.document.close();
            } else {
                alert('Por favor, permite las ventanas emergentes para generar la versi√≥n imprimible.');
            }
        }

        function mostrarConfiguracion() {
            let configuracionHTML = '';
            if (tipoDeJuegoActual === "tablaPeriodica") {
                configuracionHTML = `
                    <div class="mb-4 p-4 bg-gray-700 rounded-lg">
                        <h5 class="font-bold text-lg mb-3 text-blue-300">Configuraci√≥n Tabla Peri√≥dica:</h5>
                        <div class="flex flex-col gap-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="simbolo-checkbox" ${configActualTablaPeriodica.preguntarSimbolo ? 'checked' : ''} class="h-5 w-5 rounded bg-gray-800 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
                                <span class="text-gray-200">Preguntar por el S√≠mbolo</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="columna-checkbox" ${configActualTablaPeriodica.preguntarColumna ? 'checked' : ''} class="h-5 w-5 rounded bg-gray-800 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
                                <span class="text-gray-200">Preguntar por la Columna</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="valencias-checkbox" ${configActualTablaPeriodica.preguntarValencias ? 'checked' : ''} class="h-5 w-5 rounded bg-gray-800 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
                                <span class="text-gray-200">Preguntar por las Valencias</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="valencias-simbolo-checkbox" ${configActualTablaPeriodica.preguntarValenciasComoSimbolo ? 'checked' : ''} ${!configActualTablaPeriodica.preguntarValencias ? 'disabled' : ''} class="h-5 w-5 rounded bg-gray-800 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="text-gray-200">Preguntar Valencias con signo (+/-)</span>
                            </label>
                        </div>
                    </div>
                `;
            }

            let card = $(`
                <div class="card bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 w-full max-w-lg mx-auto transform transition-all" id="Configuracion">
                    <h3 class="text-2xl font-bold mb-4 text-white text-center">‚öôÔ∏è Configuraci√≥n de Partida</h3>
                    ${configuracionHTML}
                    <p class="mb-3 text-gray-300 font-medium">Elige el modo de juego:</p>
                    
                    <button id="modo-todas" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg mb-3 transition-colors shadow-md">
                        Todas las preguntas (${preguntasJSON.length})
                    </button>
                    
                    <button id="modo-surtido" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg mb-4 transition-colors shadow-md">
                        Surtido de preguntas
                    </button>
                    
                    <div id="config-surtido" style="display: none;" class="bg-gray-700 p-4 rounded-lg border border-gray-600">
                        <div class="mb-4">
                            <label for="num-preguntas" class="block text-sm font-medium text-gray-300 mb-1">N√∫mero de preguntas:</label>
                            <input type="number" id="num-preguntas" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" value="10" min="1" max="50">
                            <small class="block mt-1 text-gray-400 text-xs">Elige entre 1 y ${preguntasJSON.length} preguntas</small>
                        </div>
                        <button id="iniciar-quiz-surtido" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                            üöÄ Iniciar Quiz
                        </button>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <button id="generar-version-imprimible" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                            üìÑ Generar versi√≥n para imprimir
                        </button>
                    </div>
                </div>
            `);
            $('#contenedor').append(card);
            
            // Event listener para el bot√≥n de generar versi√≥n imprimible
            $('#generar-version-imprimible').on('click', function() {
                generarVersionImprimible();
            });

            $('#modo-todas').on('click', function() {
                modoJuego = 'todas';
                numeroTotalPreguntas = preguntasJSON.length;
                actualizarConfiguracionTablaPeriodicaDesdeUI();
                $('.card').remove(); // Eliminar la tarjeta de configuraci√≥n
                mostrarBienvenida(usuarioActual);
            });

            $('#modo-surtido').on('click', function() {
                modoJuego = 'surtido';
                $('#modo-todas').hide();
                $('#modo-surtido').hide();
                $('#config-surtido').slideDown(300); // jQuery effect
                // Actualizar el max del input si es necesario
                let maxPreguntas = preguntasJSON.length > 50 ? 50 : preguntasJSON.length;
                $('#num-preguntas').attr('max', maxPreguntas);
                $('#num-preguntas').val(Math.min(10, maxPreguntas)); // Default a 10 o menos si no hay tantas
                $('#config-surtido small').text(`Elige entre 1 y ${maxPreguntas} preguntas`);
            });

            $('#iniciar-quiz-surtido').on('click', function () {
                let numPreguntasInput = parseInt($('#num-preguntas').val());
                let maxPreguntas = parseInt($('#num-preguntas').attr('max'));

                if (numPreguntasInput >= 1 && numPreguntasInput <= maxPreguntas) {
                    numeroTotalPreguntas = numPreguntasInput;
                    actualizarConfiguracionTablaPeriodicaDesdeUI();
                    $('.card').remove(); // Eliminar la tarjeta de configuraci√≥n
                    mostrarBienvenida(usuarioActual);
                } else {
                    alert(`Por favor, elige un n√∫mero de preguntas entre 1 y ${maxPreguntas}`);
                }
            });
        }

        function actualizarConfiguracionTablaPeriodicaDesdeUI() {
            if (tipoDeJuegoActual === "tablaPeriodica") {
                const preguntarSimbolo = $('#simbolo-checkbox').is(':checked');
                const preguntarColumna = $('#columna-checkbox').is(':checked');
                const preguntarVal = $('#valencias-checkbox').is(':checked');
                const preguntarSimboloVal = $('#valencias-simbolo-checkbox').is(':checked');

                // Actualizar configuraci√≥n global
                configActualTablaPeriodica.preguntarSimbolo = preguntarSimbolo;
                configActualTablaPeriodica.preguntarColumna = preguntarColumna;
                configActualTablaPeriodica.preguntarValencias = preguntarVal;

                // Si la configuraci√≥n de "preguntar valencias con signo" cambi√≥ O si se des/activ√≥ preguntar valencias
                if (configActualTablaPeriodica.preguntarValenciasComoSimbolo !== preguntarSimboloVal || configActualTablaPeriodica.preguntarValencias !== preguntarVal) {
                    configActualTablaPeriodica.preguntarValenciasComoSimbolo = preguntarVal && preguntarSimboloVal;
                    
                    // Reaplica la transformaci√≥n de valencias en preguntasJSON y valenciasJuegoActual
                    if (preguntarVal) { // Solo procesar si se preguntan valencias
                        if (!configActualTablaPeriodica.preguntarValenciasComoSimbolo) { // Quitar signos
                            preguntasJSON.forEach(elemento => {
                                elemento.valencias = [...new Set((elemento.valenciasOriginales || elemento.valencias).replace(/[\\+\\-]/g, '').split(' ').map(v => v.trim()).filter(v => v.length > 0))].join(' ');
                            });
                            valenciasJuegoActual = [...new Set(todasLasValenciasPosibles.map(v => v.replace(/[\\+\\-]/g, '')))].sort((a,b) => parseInt(a) - parseInt(b));
                        } else { // Mantener/Restaurar signos
                            preguntasJSON.forEach(elemento => {
                                elemento.valencias = elemento.valenciasOriginales || elemento.valencias;
                            });
                            valenciasJuegoActual = [...new Set(todasLasValenciasPosibles)].sort((a, b) => { 
                                const numA = parseInt(a.replace(/[+-]/g, ''));
                                const numB = parseInt(b.replace(/[+-]/g, ''));
                                if (!isNaN(numA) && !isNaN(numB)) {
                                    if (numA !== numB) return numA - numB;
                                    if (a.includes('+') && !b.includes('+')) return -1;
                                    if (!a.includes('+') && b.includes('+')) return 1;
                                    if (a.includes('-') && !b.includes('-')) return 1;
                                    if (!a.includes('-') && b.includes('-')) return -1;
                                    return a.localeCompare(b); 
                                }
                                return a.localeCompare(b);
                            });
                        }
                    } else {
                        // Si no se preguntan valencias, podemos dejar las valenciasJuegoActual vac√≠as o con las originales con signo
                         preguntasJSON.forEach(elemento => {
                            elemento.valencias = elemento.valenciasOriginales || elemento.valencias; // Restaurar originales por si acaso
                        });
                        valenciasJuegoActual = [...new Set(todasLasValenciasPosibles)].sort((a, b) => { /* L√≥gica de ordenaci√≥n original */ });
                    }
                }
                // Deshabilitar checkbox de valencia con signo si no se preguntan valencias
                $('#valencias-simbolo-checkbox').prop('disabled', !preguntarVal);
                if (!preguntarVal) {
                    $('#valencias-simbolo-checkbox').prop('checked', false); // Desmarcar si est√° deshabilitado
                }
            }
        }

        function mostrarBienvenida(usuario) {
            iniciarQuiz();
        }

        function actualizarTitulo() {
            document.title = `Quiz - ${usuarioActual} - Preguntas: ${totalPreguntas}/${numeroTotalPreguntas}`;
            $('h1#titulo').text(`üëã Bienvenido ${usuarioActual} - Preguntas: ${totalPreguntas}/${numeroTotalPreguntas}`);
            // Agregar descripci√≥n desde el archivo JS
            $('#descripcion').text(curso + " - " + descripcion);
        }

        function iniciarQuiz() {
            palabraActual = seleccionarPalabra();
            if (palabraActual) {
                mostrarFormulario(palabraActual);
            }
        }

        function seleccionarPalabra() {
            let palabraSeleccionada;
            
            // Asegurarse de que preguntasJSON est√© disponible
            if (typeof preguntasJSON === 'undefined' || !preguntasJSON || preguntasJSON.length === 0) {
                console.error("preguntasJSON no est√° definido o est√° vac√≠o.");
                alert("Error: No se pudieron cargar las preguntas del juego.");
                return undefined;
            }

            // Filtrar palabras que no se han usado en esta sesi√≥n
            let palabrasDisponibles = preguntasJSON.filter(p => !palabrasUsadas.includes(p.nombre));

            if (palabrasDisponibles.length === 0) {
                // Ya se usaron todas las palabras disponibles para el modo actual
                return undefined;
            }
            
            if (modoJuego === 'todas') {
                palabraSeleccionada = palabrasDisponibles[Math.floor(Math.random() * palabrasDisponibles.length)];
            } else { // modoJuego === 'surtido'
                // Obtener estad√≠sticas almacenadas
                let resultadosGuardados = cargarResultados();
                let porcentajesPorPalabra = {};
                resultadosGuardados.forEach(r => {
                    porcentajesPorPalabra[r.palabra] = {
                        porcentaje: r.porcentaje || 0,
                        preguntas: r.preguntas || 0
                    };
                });
                
                let usarDificultad = Math.random() < 0.75;
                
                if (usarDificultad) {
                    palabrasDisponibles.sort((a, b) => {
                        let statsA = porcentajesPorPalabra[a.nombre];
                        let statsB = porcentajesPorPalabra[b.nombre];
                        let porcentajeA = statsA ? statsA.porcentaje : 0;
                        let porcentajeB = statsB ? statsB.porcentaje : 0;
                        return porcentajeA - porcentajeB;
                    });
                    
                    let indiceMax = Math.floor(palabrasDisponibles.length / 3);
                    if (indiceMax > 0) {
                        palabraSeleccionada = palabrasDisponibles[Math.floor(Math.random() * indiceMax)];
                    } else { // Si no hay suficientes para el tercio, seleccionar aleatoriamente de las disponibles
                        palabraSeleccionada = palabrasDisponibles[Math.floor(Math.random() * palabrasDisponibles.length)];
                    }
                }
                
                if (!palabraSeleccionada) {
                    palabraSeleccionada = palabrasDisponibles[Math.floor(Math.random() * palabrasDisponibles.length)];
                }
            }
            
            if (palabraSeleccionada) {
                palabrasUsadas.push(palabraSeleccionada.nombre);
            }
            return palabraSeleccionada;
        }

        function mostrarFormulario(palabra) {
            // En lugar de limpiar todo el contenedor, solo limpiamos la secci√≥n de pregunta
            $('#seccion-pregunta').remove();
            
            let contenidoFormulario = '';
            let camposPreguntados = 0; // Contador para saber cu√°ntos campos se preguntan

            if (tipoDeJuegoActual === "tablaPeriodica") {
                const elemento = palabra; // Renombrar para claridad
                
                if (configActualTablaPeriodica.preguntarColumna) {
                    camposPreguntados++;
                    let columnasButtons = columnasJuegoActual.map(columna => `
                        <button type="button" class="columna-btn m-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm transition-colors border border-gray-600" data-columna="${columna}">${columna}</button>
                    `).join('');
                    contenidoFormulario += `
                        <div class="mb-4">
                            <label class="block text-gray-300 mb-2">Columna:</label>
                            <div id="columnas-buttons" class="flex flex-wrap justify-center gap-1">${columnasButtons}</div>
                        </div>
                    `;
                }

                if (configActualTablaPeriodica.preguntarSimbolo) {
                    camposPreguntados++;
                    contenidoFormulario += `
                        <div class="mb-4">
                            <label class="block text-gray-300 mb-2">S√≠mbolo:</label>
                            <input type="text" name="simbolo" class="w-1/2 mx-auto block bg-gray-900 border border-gray-600 rounded p-2 text-white text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ej: H" autocomplete="off">
                        </div>
                    `;
                }
                
                if (configActualTablaPeriodica.preguntarValencias) {
                    camposPreguntados++;
                    let valenciasParaMostrar = valenciasJuegoActual;
                    if (!configActualTablaPeriodica.preguntarValenciasComoSimbolo) {
                        valenciasParaMostrar = valenciasParaMostrar.map(v => v.replace(/[\\+\\-]/g, ''));
                        valenciasParaMostrar = [...new Set(valenciasParaMostrar)].sort((a,b) => parseInt(a)-parseInt(b));
                    }

                    let valenciasButtonsHTML = valenciasParaMostrar.map(val => 
                        `<button type="button" class="valencia-btn m-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded min-w-[3rem] transition-colors border border-gray-600" data-valencia="${val}">${val}</button>`
                    ).join('');
                    contenidoFormulario += `
                        <div class="mb-4">
                            <label class="block text-gray-300 mb-2">Valencias:</label>
                            <div id="valencia-buttons" class="flex flex-wrap justify-center gap-1">${valenciasButtonsHTML}</div>
                        </div>
                    `;
                }

                if (camposPreguntados > 0) {
                    contenidoFormulario += `<button type="button" id="btn-enviar" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-4 transition-colors shadow-lg">Enviar</button>`;
                } else {
                    contenidoFormulario = `<p class="text-yellow-400 mb-3">No has seleccionado ninguna opci√≥n para preguntar en la configuraci√≥n. Por favor, reinicia el juego y configura qu√© aspectos deseas practicar.</p><button id="reiniciar-quiz-cfg" class="bg-cyan-600 hover:bg-cyan-700 text-white py-2 px-4 rounded">Reconfigurar</button>`;
                }

            } else { // Juego de preguntas normal
                contenidoFormulario = `
                    <form id="formulario-pregunta" class="w-full">
                        <label class="block text-gray-300 mb-2 text-left">Respuesta:</label>
                        <input type="text" name="traduccion" class="w-full bg-gray-900 border border-gray-600 rounded p-3 text-white text-lg focus:ring-2 focus:ring-blue-500 outline-none mb-4" placeholder="Escribe tu respuesta aqu√≠" autofocus autocomplete="off">
                        <button type="button" id="btn-enviar" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-lg">Enviar</button>
                    </form>
                `;
            }
            
            let card = $(`
                <div class="card bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 w-full max-w-lg mx-auto mt-6" id="seccion-pregunta">
                    <h3 class="text-2xl font-bold mb-6 text-white text-center">${prefijoPregunta} <span class="text-blue-400">${palabra.nombre}</span>${sufijoPregunta}</h3>
                    ${contenidoFormulario}
                </div>
            `);
            
            // Insertamos la nueva pregunta despu√©s del resultado si existe, o al principio si no existe
            if ($('#seccion-resultado').length) {
                $('#seccion-resultado').after(card);
            } else {
                $('#contenedor').prepend(card); // Prepend para que la pregunta aparezca antes del resultado
            }

            // Establecer el foco y eventos seg√∫n el tipo de juego
            if (tipoDeJuegoActual === "tablaPeriodica") {
                $('input[name="simbolo"]').focus();

                $('.columna-btn').on('click', function () {
                    // Update classes for Tailwind (using yellow-500 for active state)
                    $('.columna-btn').removeClass('bg-yellow-500 text-gray-900 font-bold active').addClass('bg-gray-700 text-white');
                    $(this).removeClass('bg-gray-700 text-white').addClass('bg-yellow-500 text-gray-900 font-bold active');
                });

                $('.valencia-btn').on('click', function () {
                    if ($(this).hasClass('active')) {
                         $(this).removeClass('bg-yellow-500 text-gray-900 font-bold active').addClass('bg-gray-700 text-white');
                    } else {
                         $(this).removeClass('bg-gray-700 text-white').addClass('bg-yellow-500 text-gray-900 font-bold active');
                    }
                });
                 // Vincular Enter al input de s√≠mbolo
                $('input[name="simbolo"]').on('keypress', function(event) {
                    if (event.which === 13) {
                        event.preventDefault();
                        manejarRespuestaTablaPeriodica(palabra);
                    }
                });
                 $('#btn-enviar').on('click', () => manejarRespuestaTablaPeriodica(palabra));


            } else {
                $('#formulario-pregunta input[name="traduccion"]').focus();
                 // Vincular el evento Enter al input
                $('#formulario-pregunta input[name="traduccion"]').on('keypress', function(event) {
                    if (event.which === 13) {
                        event.preventDefault();
                        let traduccionRespuesta = ($('#formulario-pregunta input[name="traduccion"]').val() || '').trim();
                        verificarRespuesta(palabra, traduccionRespuesta);
                    }
                });
                 $('#btn-enviar').on('click', () => {
                    let traduccionRespuesta = ($('#formulario-pregunta input[name="traduccion"]').val() || '').trim();
                    verificarRespuesta(palabra, traduccionRespuesta);
                });
            }
        }

        function manejarRespuestaTablaPeriodica(elemento) {
            let respuestaUsuario = {};

            if (configActualTablaPeriodica.preguntarColumna) {
                respuestaUsuario.columna = $('.columna-btn.active').data('columna') || "";
            }
            if (configActualTablaPeriodica.preguntarSimbolo) {
                respuestaUsuario.simbolo = $('input[name="simbolo"]').val().trim() || "";
            }
            if (configActualTablaPeriodica.preguntarValencias) {
                respuestaUsuario.valencias = $('.valencia-btn.active').map(function() {
                    return $(this).data('valencia').toString();
                }).get();
            }
            verificarRespuesta(elemento, respuestaUsuario);
        }

        function verificarRespuesta(palabra, respuestaUsuario) {
            let mensaje = '';
            let aciertosParciales = 0;
            let esCorrectoGlobal = false;
            let totalCamposPreguntados = 0;

            if (tipoDeJuegoActual === "tablaPeriodica") {
                const elemento = palabra; // alias
                const { columna: colRes, simbolo: simRes, valencias: valRes } = respuestaUsuario;

                mensaje = `Resultados para <strong class="text-white">${elemento.nombre}</strong> <span class="text-gray-400 text-sm">(S√≠mbolo: ${elemento.simbolo}, Columna: ${elemento.columna}, Valencias: ${elemento.valenciasOriginales || elemento.valencias})</span>:<br/><div class="mt-2 space-y-1">`;

                // Contar cu√°ntos campos se est√°n preguntando realmente
                if (configActualTablaPeriodica.preguntarSimbolo) totalCamposPreguntados++;
                if (configActualTablaPeriodica.preguntarColumna) totalCamposPreguntados++;
                if (configActualTablaPeriodica.preguntarValencias) totalCamposPreguntados++;

                if (totalCamposPreguntados === 0) {
                    // Esto no deber√≠a ocurrir si mostrarFormulario lo manej√≥ bien, pero como fallback:
                    mensaje = "No se configur√≥ ninguna pregunta para este elemento.";
                    // No se suma a totalPreguntas ni aciertos, se recarga la pregunta o se finaliza.
                    setTimeout(() => {
                        if (totalPreguntas >= numeroTotalPreguntas) {
                            $('#seccion-pregunta').remove();
                            mostrarResultadosFinales();
                        } else {
                            // No actualizar t√≠tulo aqu√≠, ya que esta pregunta no cont√≥
                            iniciarQuiz(); 
                        }
                    }, 1500);
                    return; // Salir de la funci√≥n de verificaci√≥n
                }

                let puntosPorCampo = 1 / totalCamposPreguntados;

                // Verificar S√≠mbolo (si aplica)
                if (configActualTablaPeriodica.preguntarSimbolo) {
                    if (simRes && simRes.trim().toLowerCase() === elemento.simbolo.trim().toLowerCase()) {
                        aciertosParciales += puntosPorCampo;
                        mensaje += `<div>S√≠mbolo: <span class="text-green-400 font-bold">‚úÖ ${simRes} (Correcto)</span></div>`;
                    } else {
                        mensaje += `<div>S√≠mbolo: <span class="text-red-400 font-bold">‚ùå ${simRes || '(sin respuesta)'} (Incorrecto)</span>. <span class="text-gray-400">Correcto: <span class="text-green-400">${elemento.simbolo}</span></span></div>`;
                    }
                }

                // Verificar Columna (si aplica)
                if (configActualTablaPeriodica.preguntarColumna) {
                    if (colRes && colRes.trim().toLowerCase() === elemento.columna.trim().toLowerCase()) {
                        aciertosParciales += puntosPorCampo;
                        mensaje += `<div>Columna: <span class="text-green-400 font-bold">‚úÖ ${colRes} (Correcto)</span></div>`;
                    } else {
                        mensaje += `<div>Columna: <span class="text-red-400 font-bold">‚ùå ${colRes || '(sin respuesta)'} (Incorrecto)</span>. <span class="text-gray-400">Correcto: <span class="text-green-400">${elemento.columna}</span></span></div>`;
                    }
                }

                // Verificar Valencias (si aplica)
                if (configActualTablaPeriodica.preguntarValencias) {
                    const valenciasCorrectasElemento = (configActualTablaPeriodica.preguntarValenciasComoSimbolo 
                                                    ? elemento.valenciasOriginales 
                                                    : elemento.valencias).split(' ').map(v => v.trim()).filter(v => v.length > 0).map(v => v.toString());
                    
                    const valenciasUsuarioArray = Array.isArray(valRes) ? valRes : (valRes ? [valRes.toString()] : []);

                    const todasSeleccionadasCorrectas = valenciasUsuarioArray.length === valenciasCorrectasElemento.length && valenciasUsuarioArray.every(v => valenciasCorrectasElemento.includes(v));
                    const todasCorrectasSeleccionadas = valenciasCorrectasElemento.every(v => valenciasUsuarioArray.includes(v));

                    if (todasSeleccionadasCorrectas && todasCorrectasSeleccionadas) {
                        aciertosParciales += puntosPorCampo;
                        mensaje += `<div>Valencias: <span class="text-green-400 font-bold">‚úÖ ${valenciasUsuarioArray.join(', ') || '(ninguna)'} (Correcto)</span></div>`;
                    } else {
                        mensaje += `<div>Valencias: <span class="text-red-400 font-bold">‚ùå ${valenciasUsuarioArray.join(', ') || '(ninguna)'} (Incorrecto)</span>. <span class="text-gray-400">Correctas: <span class="text-green-400">${valenciasCorrectasElemento.join(', ')}</span></span></div>`;
                    }
                }
                mensaje += "</div>";
                esCorrectoGlobal = (Math.abs(aciertosParciales - 1) < 0.001); // Sigue siendo correcto global si todos los campos preguntados son correctos

            } else { // Juego de preguntas normal
                mensaje = `Resultados para "<span class="font-bold text-blue-300">${palabra.nombre}</span>":<div class="mt-2">`;
                let respuestaNormal = respuestaUsuario || ''; // Asegurar que no sea undefined
                if (typeof respuestaNormal !== 'string') { // Si por error llega algo que no es string
                     respuestaNormal = String(respuestaNormal);
                }
                respuestaNormal = respuestaNormal.trim(); // Eliminar espacios al inicio y al final

                if (esCaseSensitive) {
                    if (respuestaNormal === palabra.respuesta.trim()) {
                        mensaje += `<span class="text-green-400 font-bold text-lg">‚úÖ ¬°Correcto! ${palabra.respuesta}</span>`;
                        esCorrectoGlobal = true;
                    } else {
                        mensaje += `<div class="text-red-400 font-bold mb-1">‚ùå Incorrecto: ${respuestaNormal || '(sin respuesta)'}</div><div class="text-gray-400">La respuesta correcta es <span class="text-green-400 font-bold">${palabra.respuesta}</span>.</div>`;
                    }
                } else {
                    if (respuestaNormal.toLowerCase() === palabra.respuesta.trim().toLowerCase()) {
                        mensaje += `<span class="text-green-400 font-bold text-lg">‚úÖ ¬°Correcto! ${palabra.respuesta}</span>`;
                        esCorrectoGlobal = true;
                    } else {
                        mensaje += `<div class="text-red-400 font-bold mb-1">‚ùå Incorrecto: ${respuestaNormal || '(sin respuesta)'}</div><div class="text-gray-400">La respuesta correcta es <span class="text-green-400 font-bold">${palabra.respuesta}</span>.</div>`;
                    }
                }
                mensaje += "</div>";
            }

            totalPreguntas++;
            if (esCorrectoGlobal) {
                aciertosTotales++;
            }

            // Actualizar estad√≠sticas
            let resultadosGuardados = cargarResultados();
            let resultadoPalabra = resultadosGuardados.find(r => r.palabra === palabra.nombre);
            let estadisticas = {
                preguntas: resultadoPalabra ? resultadoPalabra.preguntas + 1 : 1,
                aciertos: resultadoPalabra ? resultadoPalabra.aciertos : 0
            };
            if (esCorrectoGlobal) {
                estadisticas.aciertos++;
            }
            
            let nuevoResultado = {
                palabra: palabra.nombre,
                respuestaDada: (tipoDeJuegoActual === "tablaPeriodica") ? JSON.stringify(respuestaUsuario) : (respuestaUsuario || ''),
                correcto: esCorrectoGlobal,
                aciertosParciales: (tipoDeJuegoActual === "tablaPeriodica") ? aciertosParciales.toFixed(2) : undefined,
                preguntas: estadisticas.preguntas,
                aciertos: estadisticas.aciertos,
                porcentaje: (estadisticas.aciertos / estadisticas.preguntas) * 100,
                ultimaVez: new Date().toLocaleString()
            };

            let index = resultadosGuardados.findIndex(r => r.palabra === palabra.nombre);
            if (index !== -1) {
                resultadosGuardados[index] = nuevoResultado;
            } else {
                resultadosGuardados.push(nuevoResultado);
            }
            guardarResultados(resultadosGuardados);
            resultados = resultadosGuardados; // Actualizar la variable global de resultados

            mensaje += `<div class="mt-4 pt-3 border-t border-gray-700 text-sm text-gray-400">üéØ Puntos Totales: <span class="text-white font-bold">${aciertosTotales} / ${totalPreguntas}</span></div>`;

            $('#seccion-resultado').remove();
            let resultadoCard = $(`
                <div class="card bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-6 w-full max-w-lg mx-auto mb-6" id="seccion-resultado">
                    <div class="text-lg">${mensaje}</div>
                </div>
            `);
            // Insertar el resultado antes de la pregunta si la pregunta a√∫n existe, sino al final del contenedor
            if ($('#seccion-pregunta').length) {
                 $('#seccion-pregunta').before(resultadoCard);
            } else {
                 $('#contenedor').append(resultadoCard);
            }


            setTimeout(() => {
                if (totalPreguntas >= numeroTotalPreguntas) {
                    $('#seccion-pregunta').remove();
                    mostrarResultadosFinales();
                } else {
                    actualizarTitulo();
                    iniciarQuiz();
                }
            }, tipoDeJuegoActual === "tablaPeriodica" ? 3000 : 2000); // M√°s tiempo para leer resultados de tabla peri√≥dica
        }
        
        function mostrarResultadosFinales() {
            let nota = (aciertosTotales / numeroTotalPreguntas) * 100; // Calcular nota
            
            const inicioSlice = Math.max(0, resultados.length - numeroTotalPreguntas);
            const resultadosSesionActual = resultados.slice(inicioSlice);

            let resumenPreguntas = resultadosSesionActual
                .map(r => {
                    let preguntaTexto = r.palabra;
                    let respuestaDadaTexto = '';
                    let resultadoTexto = '';
                    
                    // Asegurarse de que r.respuestaDada es string antes de JSON.parse o usar directamente
                    let rawRespuestaDada = r.respuestaDada;
                    if (typeof rawRespuestaDada !== 'string') {
                        rawRespuestaDada = String(rawRespuestaDada); // Convertir a string si no lo es
                    }


                    if (tipoDeJuegoActual === "tablaPeriodica") {
                        const elemento = preguntasJSON.find(p => p.nombre === r.palabra);
                        if (!elemento) return '<tr><td colspan="3" class="p-2">Error: Elemento no encontrado</td></tr>';

                        let detallesRespuestaDada = {};
                        try {
                            // Solo parsear si es un string que parece JSON object
                            if (rawRespuestaDada.startsWith('{') && rawRespuestaDada.endsWith('}')) {
                                detallesRespuestaDada = JSON.parse(rawRespuestaDada);
                            } else if (rawRespuestaDada) { // Si no es JSON, podr√≠a ser un string simple o vac√≠o
                                // No se puede asumir una estructura, as√≠ que se podr√≠a mostrar el string crudo
                                // o intentar deducir. Para este caso, si no es JSON, no se pueden extraer detalles.
                                // Dejamos detallesRespuestaDada como objeto vac√≠o si no se puede parsear.
                            }
                        } catch(e) { 
                            console.error("Error parsing respuestaDada JSON:", e, rawRespuestaDada);
                            // Si falla el parseo, detallesRespuestaDada queda vac√≠o
                        }
                        
                        const valenciasUsuarioTexto = (detallesRespuestaDada.valencias && Array.isArray(detallesRespuestaDada.valencias)) ? detallesRespuestaDada.valencias.join(', ') : (detallesRespuestaDada.valencias || '-');

                        respuestaDadaTexto = `<div class="text-xs">Sim: ${detallesRespuestaDada.simbolo || '-'}<br/>Col: ${detallesRespuestaDada.columna || '-'}<br/>Val: ${valenciasUsuarioTexto}</div>`;
                        
                        const valenciasCorrectasText = (elemento.valenciasOriginales || elemento.valencias).split(' ').join(', ');

                        if (r.correcto) {
                            resultadoTexto = `<span class="text-green-400 font-bold">‚úÖ Correcto</span>`;
                        } else {
                            resultadoTexto = `<span class="text-red-400 font-bold">‚ùå Incorrecto</span><div class="text-xs text-gray-400 mt-1">Sim: ${elemento.simbolo}<br/>Col: ${elemento.columna}<br/>Val: ${valenciasCorrectasText}</div>`;
                        }
                    } else { // Juego de preguntas normal
                        const preguntaOriginal = preguntasJSON.find(p => p.nombre === r.palabra);
                        if (!preguntaOriginal) return '<tr><td colspan="3" class="p-2">Error: Pregunta no encontrada</td></tr>';

                        respuestaDadaTexto = rawRespuestaDada || '<span class="italic text-gray-500">(sin respuesta)</span>'; // Usar el string crudo
                        if (r.correcto) {
                            resultadoTexto = `<span class="text-green-400 font-bold">‚úÖ Correcto</span>`;
                        } else {
                            resultadoTexto = `<span class="text-red-400 font-bold">‚ùå Incorrecto</span> <span class="text-gray-400 text-sm">(${preguntaOriginal.respuesta})</span>`;
                        }
                    }
                    return `
                        <tr class="border-b border-gray-700 hover:bg-gray-700 transition-colors">
                            <td class="p-3 align-top font-medium text-blue-300">${preguntaTexto}</td>
                            <td class="p-3 align-top text-gray-300">${respuestaDadaTexto}</td>
                            <td class="p-3 align-top">${resultadoTexto}</td>
                        </tr>
                    `;
                }).join('');

            let card = $(`
                <div class="card bg-gray-800 border border-gray-700 rounded-xl shadow-2xl w-full max-w-4xl mx-auto my-10">
                    <div class="p-6 md:p-8">
                        <div class="text-center mb-8">
                            <h4 class="text-3xl font-bold text-white mb-2">üèÅ Fin del Quiz</h4>
                            <div class="text-xl text-gray-400">üíØ Nota final: <span class="font-bold ${nota >= 50 ? 'text-green-400' : 'text-red-400'}">${nota.toFixed(2)}%</span> ${nota >= 90 ? 'üéâ' : nota >= 70 ? 'üëç' : nota >= 50 ? 'üòä' : 'üí™'}</div>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-gray-700 bg-gray-900 mb-8">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-800 text-gray-400 uppercase text-xs tracking-wider">
                                    <tr>
                                        <th class="p-3 font-semibold">Pregunta</th>
                                        <th class="p-3 font-semibold">Tu respuesta</th>
                                        <th class="p-3 font-semibold">Resultado</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    ${resumenPreguntas}
                                </tbody>
                            </table>
                        </div>
                        <button id="reiniciar-quiz" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-lg">üîÑ Reiniciar Quiz</button>
                    </div>
                </div>
            `);
            $('#contenedor').append(card);

            $('#reiniciar-quiz').on('click', function () {
                reiniciarJuego();
            });
        }

        function reiniciarJuego() {
            totalPreguntas = 0;
            aciertosTotales = 0;
            palabrasUsadas = [];
            // modoJuego se mantiene o se podr√≠a resetear aqu√≠ si se desea que siempre vuelva a preguntar
            resultados = cargarResultados();
            $('#contenedor').empty(); // Limpiar el contenedor
            preguntarNombre(); // Volver a preguntar el nombre y mostrar configuraci√≥n
        }

        function mostrarAjustesUsuario() {
            // Calcular estad√≠sticas globales de todos los juegos
            let estadisticasGlobales = calcularEstadisticasGlobales();
            
            // Generar HTML de estad√≠sticas por juego
            let estadisticasPorJuegoHTML = estadisticasGlobales.juegoIndividuales.length > 0 ? `
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-blue-300 mb-3">üìä Estad√≠sticas por Juego</h4>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${estadisticasGlobales.juegoIndividuales.map(juego => `
                            <div class="bg-gray-700 rounded-lg p-3 border border-gray-600">
                                <div class="font-semibold text-white mb-1">${juego.nombre}</div>
                                <div class="grid grid-cols-3 gap-2 text-sm text-gray-300">
                                    <div>
                                        <span class="text-gray-400">Partidas:</span>
                                        <span class="font-bold text-blue-400">${juego.partidas}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Media:</span>
                                        <span class="font-bold ${juego.notaMedia >= 70 ? 'text-green-400' : juego.notaMedia >= 50 ? 'text-yellow-400' : 'text-red-400'}">${juego.notaMedia.toFixed(1)}%</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">M√°xima:</span>
                                        <span class="font-bold text-green-400">${juego.notaMaxima.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '<div class="mb-6 text-center text-gray-400">No hay estad√≠sticas disponibles a√∫n.</div>';
            
            // Obtener estado actual de la estela
            let estelaHabilitada = localStorage.getItem('estelaHabilitada') !== 'false'; // Por defecto true
            
            // Obtener foto del usuario
            let fotoUsuario = localStorage.getItem('fotoUsuario') || '';
            
            // Obtener colores del degradado
            let colores = obtenerColoresDegradado();
            
            const modal = $(`
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4" id="modal-ajustes">
                    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" id="modal-ajustes-backdrop"></div>
                    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl z-10 border border-gray-700 transform transition-all max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-bold text-white">‚öôÔ∏è Ajustes de Usuario</h3>
                                <button type="button" class="text-gray-400 hover:text-white transition-colors text-2xl leading-none focus:outline-none" id="cerrar-ajustes">
                                    &times;
                                </button>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-gray-300 mb-2 font-medium">Foto de perfil:</label>
                                <div class="flex items-center space-x-4">
                                    <div class="relative">
                                        <div id="preview-foto" class="w-20 h-20 rounded-full bg-gray-700 border-2 border-gray-600 flex items-center justify-center overflow-hidden">
                                            ${fotoUsuario ? `<img src="${fotoUsuario}" class="w-full h-full object-cover" alt="Foto de usuario">` : '<i class="fas fa-user text-3xl text-gray-500"></i>'}
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" id="input-foto-usuario" accept="image/*" class="hidden">
                                        <button id="btn-seleccionar-foto" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg mr-2">
                                            üì∑ Seleccionar Foto
                                        </button>
                                        ${fotoUsuario ? '<button id="btn-eliminar-foto" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">üóëÔ∏è Eliminar</button>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-gray-300 mb-2 font-medium">Nombre de usuario:</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="input-cambiar-nombre" class="flex-1 bg-gray-900 border border-gray-600 rounded-lg p-3 text-white text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Tu nombre">
                                    <button id="btn-guardar-nombre" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                                        Guardar
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-6 pt-4 border-t border-gray-700">
                                <h4 class="text-lg font-bold text-blue-300 mb-3">üéØ Estad√≠sticas Globales</h4>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                                        <div class="text-gray-400 text-sm mb-1">Total de Partidas</div>
                                        <div class="text-2xl font-bold text-blue-400">${estadisticasGlobales.totalPartidas}</div>
                                    </div>
                                    <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                                        <div class="text-gray-400 text-sm mb-1">Nota Media Global</div>
                                        <div class="text-2xl font-bold ${estadisticasGlobales.notaMediaGlobal >= 70 ? 'text-green-400' : estadisticasGlobales.notaMediaGlobal >= 50 ? 'text-yellow-400' : 'text-red-400'}">
                                            ${estadisticasGlobales.notaMediaGlobal.toFixed(1)}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-6 pt-4 border-t border-gray-700">
                                ${estadisticasPorJuegoHTML}
                            </div>
                            
                            <div class="mb-6 pt-4 border-t border-gray-700">
                                <h4 class="text-lg font-bold text-blue-300 mb-3">üé® Preferencias</h4>
                                
                                <label class="flex items-center space-x-3 cursor-pointer bg-gray-700 p-4 rounded-lg border border-gray-600 hover:bg-gray-600 transition-colors mb-4">
                                    <input type="checkbox" id="checkbox-estela" ${estelaHabilitada ? 'checked' : ''} class="h-5 w-5 rounded bg-gray-800 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="text-white font-medium">‚≠ê Estela del rat√≥n con estrellas</div>
                                        <div class="text-gray-400 text-sm">Habilitar o deshabilitar el efecto de estrellas siguiendo el cursor</div>
                                    </div>
                                </label>
                                
                                <div class="bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <div class="text-white font-medium mb-3">üé® Colores del Degradado de Fondo</div>
                                    <div class="text-gray-400 text-xs mb-3">Selecciona hasta 6 colores para personalizar el degradado de la aplicaci√≥n</div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div>
                                            <label class="block text-gray-400 text-xs mb-1">Color 1</label>
                                            <input type="color" id="color1" value="${colores[0]}" class="w-full h-10 rounded cursor-pointer bg-gray-900 border border-gray-600">
                                        </div>
                                        <div>
                                            <label class="block text-gray-400 text-xs mb-1">Color 2</label>
                                            <input type="color" id="color2" value="${colores[1]}" class="w-full h-10 rounded cursor-pointer bg-gray-900 border border-gray-600">
                                        </div>
                                        <div>
                                            <label class="block text-gray-400 text-xs mb-1">Color 3</label>
                                            <input type="color" id="color3" value="${colores[2]}" class="w-full h-10 rounded cursor-pointer bg-gray-900 border border-gray-600">
                                        </div>
                                        <div>
                                            <label class="block text-gray-400 text-xs mb-1">Color 4</label>
                                            <input type="color" id="color4" value="${colores[3]}" class="w-full h-10 rounded cursor-pointer bg-gray-900 border border-gray-600">
                                        </div>
                                        <div>
                                            <label class="block text-gray-400 text-xs mb-1">Color 5</label>
                                            <input type="color" id="color5" value="${colores[4]}" class="w-full h-10 rounded cursor-pointer bg-gray-900 border border-gray-600">
                                        </div>
                                        <div>
                                            <label class="block text-gray-400 text-xs mb-1">Color 6</label>
                                            <input type="color" id="color6" value="${colores[5]}" class="w-full h-10 rounded cursor-pointer bg-gray-900 border border-gray-600">
                                        </div>
                                    </div>
                                    <div class="mt-3 flex space-x-2">
                                        <button id="btn-aplicar-colores" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg">
                                            Aplicar Colores
                                        </button>
                                        <button id="btn-restaurar-colores" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">
                                            Restaurar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pt-4 border-t border-gray-700">
                                <button type="button" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md" id="btn-cerrar-ajustes">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            $('body').append(modal);
            $('#input-cambiar-nombre').val(usuarioActual || '').focus().select();
            
            const cerrarModal = () => {
                $('#modal-ajustes').fadeOut(200, function() { $(this).remove(); });
            };
            
            $('#btn-guardar-nombre').on('click', function() {
                const nuevoNombre = $('#input-cambiar-nombre').val().trim();
                if (nuevoNombre && nuevoNombre !== usuarioActual) {
                    usuarioActual = nuevoNombre;
                    setCookie('usuarioActual', usuarioActual);
                    actualizarNombreUsuario();
                    cerrarModal();
                } else if (!nuevoNombre) {
                    $('#input-cambiar-nombre').addClass('border-red-500');
                    setTimeout(() => $('#input-cambiar-nombre').removeClass('border-red-500'), 1000);
                } else {
                    cerrarModal();
                }
            });
            
            $('#input-cambiar-nombre').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#btn-guardar-nombre').click();
                }
            });
            
            // Manejar cambio de checkbox de estela
            $('#checkbox-estela').on('change', function() {
                const habilitada = $(this).is(':checked');
                localStorage.setItem('estelaHabilitada', habilitada);
                window.estelaHabilitada = habilitada;
            });
            
            // Manejar selecci√≥n de foto
            $('#btn-seleccionar-foto').on('click', function() {
                $('#input-foto-usuario').click();
            });
            
            $('#input-foto-usuario').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) { // L√≠mite de 2MB
                        alert('La imagen es demasiado grande. Por favor, selecciona una imagen menor a 2MB.');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const imagenBase64 = event.target.result;
                        localStorage.setItem('fotoUsuario', imagenBase64);
                        $('#preview-foto').html(`<img src="${imagenBase64}" class="w-full h-full object-cover" alt="Foto de usuario">`);
                        actualizarFotoUsuario();
                        // A√±adir bot√≥n eliminar si no existe
                        if (!$('#btn-eliminar-foto').length) {
                            $('#btn-seleccionar-foto').after('<button id="btn-eliminar-foto" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-lg ml-2">üóëÔ∏è Eliminar</button>');
                            $('#btn-eliminar-foto').on('click', eliminarFotoUsuario);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Manejar eliminaci√≥n de foto
            $('#btn-eliminar-foto').on('click', eliminarFotoUsuario);
            
            function eliminarFotoUsuario() {
                localStorage.removeItem('fotoUsuario');
                $('#preview-foto').html('<i class="fas fa-user text-3xl text-gray-500"></i>');
                $('#btn-eliminar-foto').remove();
                actualizarFotoUsuario();
            }
            
            // Manejar aplicaci√≥n de colores
            $('#btn-aplicar-colores').on('click', function() {
                const colores = [
                    $('#color1').val(),
                    $('#color2').val(),
                    $('#color3').val(),
                    $('#color4').val(),
                    $('#color5').val(),
                    $('#color6').val()
                ];
                guardarColoresDegradado(colores);
                aplicarDegradado(colores);
            });
            
            // Restaurar colores por defecto
            $('#btn-restaurar-colores').on('click', function() {
                const coloresDefecto = ['#1e3a8a', '#3b82f6', '#60a5fa', '#8b5cf6', '#a78bfa', '#1e3a8a'];
                $('#color1').val(coloresDefecto[0]);
                $('#color2').val(coloresDefecto[1]);
                $('#color3').val(coloresDefecto[2]);
                $('#color4').val(coloresDefecto[3]);
                $('#color5').val(coloresDefecto[4]);
                $('#color6').val(coloresDefecto[5]);
                guardarColoresDegradado(coloresDefecto);
                aplicarDegradado(coloresDefecto);
            });
            
            $('#cerrar-ajustes, #btn-cerrar-ajustes, #modal-ajustes-backdrop').on('click', cerrarModal);
        }
        
        function calcularEstadisticasGlobales() {
            let totalPartidas = 0;
            let sumaNotas = 0;
            let juegoIndividuales = [];
            
            // Obtener todos los juegos guardados en localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('resultados_')) {
                    const nombreJuego = key.replace('resultados_', '');
                    const resultadosJuego = JSON.parse(localStorage.getItem(key)) || [];
                    
                    if (resultadosJuego.length > 0) {
                        // Calcular estad√≠sticas por juego
                        let totalPreguntasJuego = 0;
                        let totalAciertosJuego = 0;
                        let notaMaxima = 0;
                        
                        resultadosJuego.forEach(r => {
                            totalPreguntasJuego += r.preguntas || 0;
                            totalAciertosJuego += r.aciertos || 0;
                            if (r.porcentaje > notaMaxima) {
                                notaMaxima = r.porcentaje;
                            }
                        });
                        
                        const notaMedia = totalPreguntasJuego > 0 ? (totalAciertosJuego / totalPreguntasJuego) * 100 : 0;
                        
                        juegoIndividuales.push({
                            nombre: nombreJuego,
                            partidas: totalPreguntasJuego,
                            notaMedia: notaMedia,
                            notaMaxima: notaMaxima
                        });
                        
                        totalPartidas += totalPreguntasJuego;
                        sumaNotas += totalAciertosJuego;
                    }
                }
            }
            
            const notaMediaGlobal = totalPartidas > 0 ? (sumaNotas / totalPartidas) * 100 : 0;
            
            return {
                totalPartidas: totalPartidas,
                notaMediaGlobal: notaMediaGlobal,
                juegoIndividuales: juegoIndividuales.sort((a, b) => b.partidas - a.partidas) // Ordenar por n√∫mero de partidas
            };
        }
        
        function obtenerColoresDegradado() {
            const coloresGuardados = localStorage.getItem('coloresDegradado');
            if (coloresGuardados) {
                return JSON.parse(coloresGuardados);
            }
            // Colores por defecto
            return ['#1e3a8a', '#3b82f6', '#60a5fa', '#8b5cf6', '#a78bfa', '#1e3a8a'];
        }
        
        function guardarColoresDegradado(colores) {
            localStorage.setItem('coloresDegradado', JSON.stringify(colores));
        }
        
        function aplicarDegradado(colores) {
            const gradiente = `linear-gradient(-45deg, ${colores.join(', ')})`;
            $('body').css({
                'background': gradiente,
                'background-size': '400% 400%',
                'background-attachment': 'fixed'
            });
        }
        
        function actualizarFotoUsuario() {
            const foto = localStorage.getItem('fotoUsuario');
            const displayElement = $('#nombre-usuario-display');
            if (foto) {
                displayElement.html(`<img src="${foto}" class="w-6 h-6 rounded-full object-cover mr-2" alt="Foto"><span>${usuarioActual}</span>`);
            } else {
                displayElement.html(`<i class="fas fa-user mr-2"></i><span>${usuarioActual}</span>`);
            }
        }

        function mostrarEstadisticas() {
            const resultadosGuardados = cargarResultados();
            let resultadosAgrupados = {};
            
            resultadosGuardados.forEach(r => {
                if (!resultadosAgrupados[r.palabra]) {
                    resultadosAgrupados[r.palabra] = {
                        preguntas: r.preguntas,
                        aciertos: r.aciertos,
                        porcentaje: r.porcentaje,
                        ultimaVez: r.ultimaVez
                    };
                } else {
                    resultadosAgrupados[r.palabra].preguntas = r.preguntas;
                    resultadosAgrupados[r.palabra].aciertos = r.aciertos;
                    resultadosAgrupados[r.palabra].porcentaje = r.porcentaje;
                    resultadosAgrupados[r.palabra].ultimaVez = r.ultimaVez;
                }
            });

            let resultadosHTML = `
                <div class="overflow-x-auto rounded-lg border border-gray-600 bg-gray-900 max-h-[60vh] overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-800 text-gray-400 uppercase text-xs tracking-wider sticky top-0">
                            <tr>
                                <th class="p-3 font-semibold">Pregunta</th>
                                <th class="p-3 font-semibold text-center">Veces</th>
                                <th class="p-3 font-semibold text-center">Aciertos</th>
                                <th class="p-3 font-semibold text-center">%</th>
                                <th class="p-3 font-semibold">√öltima vez</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${Object.entries(resultadosAgrupados)
                                .sort(([palabraA], [palabraB]) => palabraA.localeCompare(palabraB))
                                .map(([palabra, stats]) => {
                                const colorClass = stats.porcentaje >= 85 ? 'text-green-400' : (stats.porcentaje >= 50 ? 'text-yellow-400' : 'text-red-400');
                                const emoji = stats.porcentaje >= 85 ? 'üèÜ' : (stats.porcentaje >= 50 ? 'üëç' : 'üí™');
                                return `
                                    <tr class="hover:bg-gray-800">
                                        <td class="p-3 font-medium text-gray-200">${palabra}</td>
                                        <td class="p-3 text-center text-gray-400">${stats.preguntas}</td>
                                        <td class="p-3 text-center text-gray-400">‚úÖ ${stats.aciertos}</td>
                                        <td class="p-3 text-center font-bold ${colorClass}">${emoji} ${stats.porcentaje.toFixed(2)}%</td>
                                        <td class="p-3 text-sm text-gray-500">${stats.ultimaVez || 'N/A'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            let modal = $(`
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4" id="modal-estadisticas">
                    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" id="modal-backdrop"></div>
                    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl z-10 flex flex-col max-h-[90vh] border border-gray-700 transform transition-all scale-100">
                        <div class="p-5 border-b border-gray-700 flex justify-between items-center">
                            <h5 class="text-xl font-bold text-white">üìä Estad√≠sticas de ${juegoActual}</h5>
                            <button type="button" class="text-gray-400 hover:text-white transition-colors text-2xl leading-none focus:outline-none" id="close-modal">
                                &times;
                            </button>
                        </div>
                        <div class="p-6 overflow-hidden flex-1">
                            ${resultadosHTML}
                        </div>
                        <div class="p-5 border-t border-gray-700 flex justify-between">
                            <button id="borrar-estadisticas" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-md">Borrar Todo</button>
                            <button type="button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded transition-colors shadow-md" id="btn-cerrar-modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            `);
            
            $('body').append(modal);
            // Simple animation for showing
            $('#modal-backdrop').hide().fadeIn(200);

            const closeModal = () => {
                 $('#modal-estadisticas').fadeOut(200, function() { $(this).remove(); });
            };

            $('#close-modal, #btn-cerrar-modal, #modal-backdrop').on('click', closeModal);

            $('#borrar-estadisticas').on('click', function () {
                if(confirm("¬øEst√°s seguro de que quieres borrar todas las estad√≠sticas de este juego?")) {
                    const claveStorage = `resultados_${juegoActual}`;
                    localStorage.removeItem(claveStorage);
                    resultados = [];
                    closeModal();
                }
            });
        }

        window.onload = function() {
            // Aplicar colores del degradado guardados
            const coloresGuardados = obtenerColoresDegradado();
            aplicarDegradado(coloresGuardados);
            
            cargarJuego()
                .then(() => {
                    resultados = cargarResultados();
                    preguntarNombre();
                    $('#ver-estadisticas').on('click', function() {
                        mostrarEstadisticas();
                    });
                    $('#btn-usuario').on('click', function() {
                        mostrarAjustesUsuario();
                    });
                    // Actualizar el nombre y foto en el bot√≥n si ya existe
                    if (usuarioActual) {
                        actualizarFotoUsuario();
                    }
                })
                .catch(error => {
                    console.error('Error al cargar el juego:', error);
                    alert('Error al cargar el juego: ' + error.message);
                    window.location.href = 'index.html';
                });
        };
    </script>
    
    <script>
        // Efecto de estrellas que siguen el cursor
        let mouseX = 0;
        let mouseY = 0;
        let lastStarTime = 0;
        const starInterval = 50; // Milisegundos entre estrellas
        
        // Variable global para controlar si la estela est√° habilitada
        window.estelaHabilitada = localStorage.getItem('estelaHabilitada') !== 'false'; // Por defecto true
        
        // Funci√≥n para crear una estrella
        function createStar(x, y, isMain = false) {
            // Verificar si la estela est√° habilitada
            if (!window.estelaHabilitada) return;
            
            const container = document.getElementById('stars-container');
            if (!container) return; // Asegurarse de que el contenedor existe
            
            const star = document.createElement('div');
            
            if (isMain) {
                // Estrella principal m√°s grande
                const size = Math.random() * 8 + 6;
                star.className = 'star';
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = x - size / 2 + 'px';
                star.style.top = y - size / 2 + 'px';
                star.style.background = `radial-gradient(circle, 
                    rgba(255, 255, 255, 0.9) 0%, 
                    rgba(147, 197, 253, 0.7) 40%, 
                    rgba(139, 92, 246, 0.5) 70%, 
                    transparent 100%)`;
                star.style.boxShadow = `0 0 ${size * 2}px rgba(147, 197, 253, 0.8), 
                    0 0 ${size * 3}px rgba(139, 92, 246, 0.6)`;
            } else {
                // Estrella peque√±a de rastro
                star.className = 'star-trail';
                star.style.left = x - 2 + 'px';
                star.style.top = y - 2 + 'px';
            }
            
            container.appendChild(star);
            
            // Eliminar la estrella despu√©s de la animaci√≥n
            setTimeout(() => {
                if (star.parentNode) {
                    star.parentNode.removeChild(star);
                }
            }, 1500);
        }
        
        // Seguir el movimiento del rat√≥n
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            
            const currentTime = Date.now();
            
            // Crear estrella principal cada cierto intervalo
            if (currentTime - lastStarTime > starInterval) {
                createStar(mouseX, mouseY, true);
                lastStarTime = currentTime;
            }
            
            // Crear peque√±as estrellas de rastro m√°s frecuentemente
            if (Math.random() > 0.7) {
                createStar(
                    mouseX + (Math.random() - 0.5) * 20,
                    mouseY + (Math.random() - 0.5) * 20,
                    false
                );
            }
        });
        
        // Crear estrellas adicionales cuando el rat√≥n se detiene
        let mouseStopTimer;
        document.addEventListener('mousemove', () => {
            clearTimeout(mouseStopTimer);
            mouseStopTimer = setTimeout(() => {
                // Crear algunas estrellas finales cuando el rat√≥n se detiene
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        createStar(
                            mouseX + (Math.random() - 0.5) * 30,
                            mouseY + (Math.random() - 0.5) * 30,
                            Math.random() > 0.5
                        );
                    }, i * 100);
                }
            }, 200);
        });
    </script>
</head>

<body class="bg-gray-900 text-white min-h-screen font-sans flex flex-col p-4">
    <!-- Contenedor para las estrellas del cursor -->
    <div id="stars-container"></div>
    
    <a href="index.html" class="fixed top-4 left-4 z-40 bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-full shadow-lg border border-gray-600 transition-colors flex items-center justify-center group" title="Volver al Inicio">
        <i class="fas fa-home text-lg group-hover:scale-110 transition-transform"></i>
    </a>
    
    <button id="btn-usuario" class="fixed top-4 right-4 z-40 bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow-lg border border-gray-600 transition-colors flex items-center space-x-2 group" title="Ajustes de usuario">
        <span id="nombre-usuario-display" class="flex items-center">
            <i class="fas fa-user mr-2"></i>Usuario
        </span>
    </button>
    
    <div class="container mx-auto max-w-2xl flex-grow flex flex-col items-center justify-start pt-16">
        <header class="text-center mb-6 w-full">
            <h1 id="titulo" class="text-3xl font-bold text-blue-400 mb-2"></h1>
            <div id="descripcion" class="text-gray-400 text-sm"></div>
        </header>

        <div id="contenedor" class="w-full flex flex-col items-center">
            <!-- Aqu√≠ se insertar√°n din√°micamente la pregunta y el resultado -->
        </div>
    </div>

    <footer class="w-full text-center py-6 mt-auto">
        <button id="ver-estadisticas" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg border border-purple-500 transform hover:scale-105">
            üìä Ver Estad√≠sticas
        </button>
    </footer>
</body>

</html>