<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titulo</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748', // Custom lighter gray for inputs/cards
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS Bundle removed as we don't need it for Tailwind, but some logic might rely on it? 
         Logic relies on $().modal(), which is Bootstrap. I need to replace modal logic. 
         I will remove Bootstrap JS and implement a simple custom modal function. -->
    <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script> -->

    <script>
        // Cargar el juego din√°micamente basado en el querystring
        function cargarJuego() {
            const urlParams = new URLSearchParams(window.location.search);
            const juegoId = urlParams.get('juego') || '2Pri-Ingles'; // Si no hay juego, usar 2Pri-Ingles por defecto
            
            // Actualizar juegoActual globalmente
            juegoActual = juegoId;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = `games/${juegoId}.js`;
                script.onload = () => {
                    // Verificar que preguntasJSON se haya cargado correctamente
                    if (typeof preguntasJSON === 'undefined' || !preguntasJSON) {
                        reject(new Error('preguntasJSON no se carg√≥ correctamente'));
                        return;
                    }

                    // Una vez cargado el script del juego, leemos sus variables globales
                    tipoDeJuegoActual = tipoJuego || "normal"; // Asumiendo que tipoJuego est√° definido en el archivo JS del juego
                    esCaseSensitive = typeof caseSensitive !== 'undefined' ? caseSensitive : false;

                    // Solo cargar configuraciones espec√≠ficas si es juego de tabla peri√≥dica
                    if (tipoDeJuegoActual === "tablaPeriodica") {
                        configActualTablaPeriodica = configuracionTablaPeriodica || {};
                        columnasJuegoActual = columnasDisponibles || [];
                        valenciasJuegoActual = todasLasValenciasPosibles || [];

                        // Modificar preguntasJSON para tabla peri√≥dica si es necesario
                        if (!configActualTablaPeriodica.preguntarValenciasComoSimbolo) {
                            preguntasJSON.forEach(elemento => {
                                elemento.valenciasOriginales = elemento.valencias; // Guardar originales por si acaso
                                elemento.valencias = [...new Set(elemento.valencias.replace(/[\\+\\-]/g, '').split(' '))].join(' ');
                            });
                            valenciasJuegoActual = [...new Set(valenciasJuegoActual.map(v => v.replace(/[\\+\\-]/g, '')))].sort((a,b) => parseInt(a) - parseInt(b));
                        }
                    } else {
                        // Para juegos normales, inicializar variables vac√≠as para evitar errores
                        configActualTablaPeriodica = {};
                        columnasJuegoActual = [];
                        valenciasJuegoActual = [];
                    }

                    console.log("Tipo de juego cargado:", tipoDeJuegoActual);
                    console.log("preguntasJSON cargado con", preguntasJSON.length, "preguntas");
                    resolve();
                };
                script.onerror = () => {
                    reject(new Error('Error al cargar el archivo del juego'));
                };
                document.head.appendChild(script);
            });
        }
    </script>

    <script>
        // Registra el Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

    <script>
        let resultados = []; // Se inicializar√° en el load
        let palabraActual;
        let totalPreguntas = 0;
        let numeroTotalPreguntas = 10;
        let palabrasUsadas = [];
        let aciertosTotales = 0;
        let juegoActual = window.juegoActual || '2Pri-Ingles';
        let modoJuego = 'surtido'; // 'surtido' o 'todas'
        
        // Variables para el tipo de juego y configuraci√≥n espec√≠fica
        let tipoDeJuegoActual = ""; // Se establecer√° en cargarJuego
        let esCaseSensitive = false; // Se establecer√° en cargarJuego, por defecto false
        let configActualTablaPeriodica = {}; // Se llenar√° desde el JS del juego si es tablaPeriodica
        let columnasJuegoActual = []; // Para tablaPeriodica
        let valenciasJuegoActual = []; // Para tablaPeriodica

        // Funciones para manejar cookies
        function getCookie(nombre) {
            let nombreCookie = `${nombre}=`;
            let decodedCookie = decodeURIComponent(document.cookie);
            let cookiesArray = decodedCookie.split(';');
            for (let i = 0; i < cookiesArray.length; i++) {
                let cookie = cookiesArray[i].trim();
                if (cookie.indexOf(nombreCookie) === 0) {
                    return cookie.substring(nombreCookie.length, cookie.length);
                }
            }
            return "";
        }

        function setCookie(nombre, valor) {
            // Cookie sin fecha de expiraci√≥n (persistente hasta que se borre manualmente)
            document.cookie = `${nombre}=${valor}; path=/; SameSite=Lax`;
        }

        // Cargar usuario desde cookie
        let usuarioActual = getCookie("usuarioActual");

        // Modificar la gesti√≥n de resultados para ser espec√≠fica por juego
        function cargarResultados() {
            console.log('Cargando resultados para juego:', juegoActual);
            // Usar una clave espec√≠fica para cada juego
            const claveStorage = `resultados_${juegoActual}`;
            resultados = JSON.parse(localStorage.getItem(claveStorage)) || [];
            console.log('Resultados cargados:', resultados);
            return resultados;
        }

        function guardarResultados(nuevosResultados) {
            console.log('Guardando resultados para juego:', juegoActual);
            // Usar una clave espec√≠fica para cada juego
            const claveStorage = `resultados_${juegoActual}`;
            localStorage.setItem(claveStorage, JSON.stringify(nuevosResultados));
            console.log('Resultados guardados:', nuevosResultados);
        }

        function mostrarModalNombre() {
            const modal = $(`
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4" id="modal-nombre">
                    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" id="modal-nombre-backdrop"></div>
                    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md z-10 border border-gray-700 transform transition-all">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold text-white mb-4 text-center">üëã ¬°Bienvenido!</h3>
                            <p class="text-gray-300 mb-4 text-center">Por favor, ingresa tu nombre para comenzar:</p>
                            <input type="text" id="input-nombre" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none mb-4" placeholder="Tu nombre" autofocus>
                            <button id="btn-confirmar-nombre" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-lg">
                                Continuar
                            </button>
                        </div>
                    </div>
                </div>
            `);
            
            $('body').append(modal);
            $('#input-nombre').focus();
            
            const cerrarModal = () => {
                $('#modal-nombre').fadeOut(200, function() { $(this).remove(); });
            };
            
            $('#btn-confirmar-nombre').on('click', function() {
                const nombre = $('#input-nombre').val().trim();
                if (nombre) {
                    usuarioActual = nombre;
                    setCookie('usuarioActual', usuarioActual);
                    actualizarNombreUsuario();
                    cerrarModal();
                    mostrarConfiguracion();
                } else {
                    $('#input-nombre').addClass('border-red-500');
                    setTimeout(() => $('#input-nombre').removeClass('border-red-500'), 1000);
                }
            });
            
            $('#input-nombre').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#btn-confirmar-nombre').click();
                }
            });
            
            $('#modal-nombre-backdrop').on('click', function() {
                // No permitir cerrar sin nombre
                const nombre = $('#input-nombre').val().trim();
                if (!nombre) {
                    $('#input-nombre').addClass('border-red-500');
                    setTimeout(() => $('#input-nombre').removeClass('border-red-500'), 1000);
                }
            });
        }

        function actualizarNombreUsuario() {
            // Establecer t√≠tulo inicial sin contador de preguntas
            document.title = `Quiz - ${usuarioActual}`;
            $('h1#titulo').text(`Bienvenido ${usuarioActual}`);
            $('#nombre-usuario-display').text(usuarioActual);
        }

        function preguntarNombre() {
            if (!usuarioActual) {
                mostrarModalNombre();
            } else {
                actualizarNombreUsuario();
                mostrarConfiguracion();
            }
        }

        function mostrarConfiguracion() {
            let configuracionHTML = '';
            if (tipoDeJuegoActual === "tablaPeriodica") {
                configuracionHTML = `
                    <div class="mb-4 p-4 bg-gray-700 rounded-lg">
                        <h5 class="font-bold text-lg mb-3 text-blue-300">Configuraci√≥n Tabla Peri√≥dica:</h5>
                        <div class="flex flex-col gap-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="simbolo-checkbox" ${configActualTablaPeriodica.preguntarSimbolo ? 'checked' : ''} class="h-5 w-5 rounded bg-gray-800 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
                                <span class="text-gray-200">Preguntar por el S√≠mbolo</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="columna-checkbox" ${configActualTablaPeriodica.preguntarColumna ? 'checked' : ''} class="h-5 w-5 rounded bg-gray-800 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
                                <span class="text-gray-200">Preguntar por la Columna</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="valencias-checkbox" ${configActualTablaPeriodica.preguntarValencias ? 'checked' : ''} class="h-5 w-5 rounded bg-gray-800 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer">
                                <span class="text-gray-200">Preguntar por las Valencias</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="valencias-simbolo-checkbox" ${configActualTablaPeriodica.preguntarValenciasComoSimbolo ? 'checked' : ''} ${!configActualTablaPeriodica.preguntarValencias ? 'disabled' : ''} class="h-5 w-5 rounded bg-gray-800 border-gray-600 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="text-gray-200">Preguntar Valencias con signo (+/-)</span>
                            </label>
                        </div>
                    </div>
                `;
            }

            let card = $(`
                <div class="card bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 w-full max-w-lg mx-auto transform transition-all" id="Configuracion">
                    <h3 class="text-2xl font-bold mb-4 text-white text-center">‚öôÔ∏è Configuraci√≥n de Partida</h3>
                    ${configuracionHTML}
                    <p class="mb-3 text-gray-300 font-medium">Elige el modo de juego:</p>
                    
                    <button id="modo-todas" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg mb-3 transition-colors shadow-md">
                        Todas las preguntas (${preguntasJSON.length})
                    </button>
                    
                    <button id="modo-surtido" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg mb-4 transition-colors shadow-md">
                        Surtido de preguntas
                    </button>
                    
                    <div id="config-surtido" style="display: none;" class="bg-gray-700 p-4 rounded-lg border border-gray-600">
                        <div class="mb-4">
                            <label for="num-preguntas" class="block text-sm font-medium text-gray-300 mb-1">N√∫mero de preguntas:</label>
                            <input type="number" id="num-preguntas" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" value="10" min="1" max="50">
                            <small class="block mt-1 text-gray-400 text-xs">Elige entre 1 y ${preguntasJSON.length} preguntas</small>
                        </div>
                        <button id="iniciar-quiz-surtido" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                            üöÄ Iniciar Quiz
                        </button>
                    </div>
                </div>
            `);
            $('#contenedor').append(card);

            $('#modo-todas').on('click', function() {
                modoJuego = 'todas';
                numeroTotalPreguntas = preguntasJSON.length;
                actualizarConfiguracionTablaPeriodicaDesdeUI();
                $('.card').remove(); // Eliminar la tarjeta de configuraci√≥n
                mostrarBienvenida(usuarioActual);
            });

            $('#modo-surtido').on('click', function() {
                modoJuego = 'surtido';
                $('#modo-todas').hide();
                $('#modo-surtido').hide();
                $('#config-surtido').slideDown(300); // jQuery effect
                // Actualizar el max del input si es necesario
                let maxPreguntas = preguntasJSON.length > 50 ? 50 : preguntasJSON.length;
                $('#num-preguntas').attr('max', maxPreguntas);
                $('#num-preguntas').val(Math.min(10, maxPreguntas)); // Default a 10 o menos si no hay tantas
                $('#config-surtido small').text(`Elige entre 1 y ${maxPreguntas} preguntas`);
            });

            $('#iniciar-quiz-surtido').on('click', function () {
                let numPreguntasInput = parseInt($('#num-preguntas').val());
                let maxPreguntas = parseInt($('#num-preguntas').attr('max'));

                if (numPreguntasInput >= 1 && numPreguntasInput <= maxPreguntas) {
                    numeroTotalPreguntas = numPreguntasInput;
                    actualizarConfiguracionTablaPeriodicaDesdeUI();
                    $('.card').remove(); // Eliminar la tarjeta de configuraci√≥n
                    mostrarBienvenida(usuarioActual);
                } else {
                    alert(`Por favor, elige un n√∫mero de preguntas entre 1 y ${maxPreguntas}`);
                }
            });
        }

        function actualizarConfiguracionTablaPeriodicaDesdeUI() {
            if (tipoDeJuegoActual === "tablaPeriodica") {
                const preguntarSimbolo = $('#simbolo-checkbox').is(':checked');
                const preguntarColumna = $('#columna-checkbox').is(':checked');
                const preguntarVal = $('#valencias-checkbox').is(':checked');
                const preguntarSimboloVal = $('#valencias-simbolo-checkbox').is(':checked');

                // Actualizar configuraci√≥n global
                configActualTablaPeriodica.preguntarSimbolo = preguntarSimbolo;
                configActualTablaPeriodica.preguntarColumna = preguntarColumna;
                configActualTablaPeriodica.preguntarValencias = preguntarVal;

                // Si la configuraci√≥n de "preguntar valencias con signo" cambi√≥ O si se des/activ√≥ preguntar valencias
                if (configActualTablaPeriodica.preguntarValenciasComoSimbolo !== preguntarSimboloVal || configActualTablaPeriodica.preguntarValencias !== preguntarVal) {
                    configActualTablaPeriodica.preguntarValenciasComoSimbolo = preguntarVal && preguntarSimboloVal;
                    
                    // Reaplica la transformaci√≥n de valencias en preguntasJSON y valenciasJuegoActual
                    if (preguntarVal) { // Solo procesar si se preguntan valencias
                        if (!configActualTablaPeriodica.preguntarValenciasComoSimbolo) { // Quitar signos
                            preguntasJSON.forEach(elemento => {
                                elemento.valencias = [...new Set((elemento.valenciasOriginales || elemento.valencias).replace(/[\\+\\-]/g, '').split(' '))].join(' ');
                            });
                            valenciasJuegoActual = [...new Set(todasLasValenciasPosibles.map(v => v.replace(/[\\+\\-]/g, '')))].sort((a,b) => parseInt(a) - parseInt(b));
                        } else { // Mantener/Restaurar signos
                            preguntasJSON.forEach(elemento => {
                                elemento.valencias = elemento.valenciasOriginales || elemento.valencias;
                            });
                            valenciasJuegoActual = [...new Set(todasLasValenciasPosibles)].sort((a, b) => { 
                                const numA = parseInt(a.replace(/[+-]/g, ''));
                                const numB = parseInt(b.replace(/[+-]/g, ''));
                                if (!isNaN(numA) && !isNaN(numB)) {
                                    if (numA !== numB) return numA - numB;
                                    if (a.includes('+') && !b.includes('+')) return -1;
                                    if (!a.includes('+') && b.includes('+')) return 1;
                                    if (a.includes('-') && !b.includes('-')) return 1;
                                    if (!a.includes('-') && b.includes('-')) return -1;
                                    return a.localeCompare(b); 
                                }
                                return a.localeCompare(b);
                            });
                        }
                    } else {
                        // Si no se preguntan valencias, podemos dejar las valenciasJuegoActual vac√≠as o con las originales con signo
                         preguntasJSON.forEach(elemento => {
                            elemento.valencias = elemento.valenciasOriginales || elemento.valencias; // Restaurar originales por si acaso
                        });
                        valenciasJuegoActual = [...new Set(todasLasValenciasPosibles)].sort((a, b) => { /* L√≥gica de ordenaci√≥n original */ });
                    }
                }
                // Deshabilitar checkbox de valencia con signo si no se preguntan valencias
                $('#valencias-simbolo-checkbox').prop('disabled', !preguntarVal);
                if (!preguntarVal) {
                    $('#valencias-simbolo-checkbox').prop('checked', false); // Desmarcar si est√° deshabilitado
                }
            }
        }

        function mostrarBienvenida(usuario) {
            iniciarQuiz();
        }

        function actualizarTitulo() {
            document.title = `Quiz - ${usuarioActual} - Preguntas: ${totalPreguntas}/${numeroTotalPreguntas}`;
            $('h1#titulo').text(`üëã Bienvenido ${usuarioActual} - Preguntas: ${totalPreguntas}/${numeroTotalPreguntas}`);
            // Agregar descripci√≥n desde el archivo JS
            $('#descripcion').text(curso + " - " + descripcion);
        }

        function iniciarQuiz() {
            palabraActual = seleccionarPalabra();
            if (palabraActual) {
                mostrarFormulario(palabraActual);
            }
        }

        function seleccionarPalabra() {
            let palabraSeleccionada;
            
            // Asegurarse de que preguntasJSON est√© disponible
            if (typeof preguntasJSON === 'undefined' || !preguntasJSON || preguntasJSON.length === 0) {
                console.error("preguntasJSON no est√° definido o est√° vac√≠o.");
                alert("Error: No se pudieron cargar las preguntas del juego.");
                return undefined;
            }

            // Filtrar palabras que no se han usado en esta sesi√≥n
            let palabrasDisponibles = preguntasJSON.filter(p => !palabrasUsadas.includes(p.nombre));

            if (palabrasDisponibles.length === 0) {
                // Ya se usaron todas las palabras disponibles para el modo actual
                return undefined;
            }
            
            if (modoJuego === 'todas') {
                palabraSeleccionada = palabrasDisponibles[Math.floor(Math.random() * palabrasDisponibles.length)];
            } else { // modoJuego === 'surtido'
                // Obtener estad√≠sticas almacenadas
                let resultadosGuardados = cargarResultados();
                let porcentajesPorPalabra = {};
                resultadosGuardados.forEach(r => {
                    porcentajesPorPalabra[r.palabra] = {
                        porcentaje: r.porcentaje || 0,
                        preguntas: r.preguntas || 0
                    };
                });
                
                let usarDificultad = Math.random() < 0.75;
                
                if (usarDificultad) {
                    palabrasDisponibles.sort((a, b) => {
                        let statsA = porcentajesPorPalabra[a.nombre];
                        let statsB = porcentajesPorPalabra[b.nombre];
                        let porcentajeA = statsA ? statsA.porcentaje : 0;
                        let porcentajeB = statsB ? statsB.porcentaje : 0;
                        return porcentajeA - porcentajeB;
                    });
                    
                    let indiceMax = Math.floor(palabrasDisponibles.length / 3);
                    if (indiceMax > 0) {
                        palabraSeleccionada = palabrasDisponibles[Math.floor(Math.random() * indiceMax)];
                    } else { // Si no hay suficientes para el tercio, seleccionar aleatoriamente de las disponibles
                        palabraSeleccionada = palabrasDisponibles[Math.floor(Math.random() * palabrasDisponibles.length)];
                    }
                }
                
                if (!palabraSeleccionada) {
                    palabraSeleccionada = palabrasDisponibles[Math.floor(Math.random() * palabrasDisponibles.length)];
                }
            }
            
            if (palabraSeleccionada) {
                palabrasUsadas.push(palabraSeleccionada.nombre);
            }
            return palabraSeleccionada;
        }

        function mostrarFormulario(palabra) {
            // En lugar de limpiar todo el contenedor, solo limpiamos la secci√≥n de pregunta
            $('#seccion-pregunta').remove();
            
            let contenidoFormulario = '';
            let camposPreguntados = 0; // Contador para saber cu√°ntos campos se preguntan

            if (tipoDeJuegoActual === "tablaPeriodica") {
                const elemento = palabra; // Renombrar para claridad
                
                if (configActualTablaPeriodica.preguntarColumna) {
                    camposPreguntados++;
                    let columnasButtons = columnasJuegoActual.map(columna => `
                        <button type="button" class="columna-btn m-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm transition-colors border border-gray-600" data-columna="${columna}">${columna}</button>
                    `).join('');
                    contenidoFormulario += `
                        <div class="mb-4">
                            <label class="block text-gray-300 mb-2">Columna:</label>
                            <div id="columnas-buttons" class="flex flex-wrap justify-center gap-1">${columnasButtons}</div>
                        </div>
                    `;
                }

                if (configActualTablaPeriodica.preguntarSimbolo) {
                    camposPreguntados++;
                    contenidoFormulario += `
                        <div class="mb-4">
                            <label class="block text-gray-300 mb-2">S√≠mbolo:</label>
                            <input type="text" name="simbolo" class="w-1/2 mx-auto block bg-gray-900 border border-gray-600 rounded p-2 text-white text-center text-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ej: H" autocomplete="off">
                        </div>
                    `;
                }
                
                if (configActualTablaPeriodica.preguntarValencias) {
                    camposPreguntados++;
                    let valenciasParaMostrar = valenciasJuegoActual;
                    if (!configActualTablaPeriodica.preguntarValenciasComoSimbolo) {
                        valenciasParaMostrar = valenciasParaMostrar.map(v => v.replace(/[\\+\\-]/g, ''));
                        valenciasParaMostrar = [...new Set(valenciasParaMostrar)].sort((a,b) => parseInt(a)-parseInt(b));
                    }

                    let valenciasButtonsHTML = valenciasParaMostrar.map(val => 
                        `<button type="button" class="valencia-btn m-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded min-w-[3rem] transition-colors border border-gray-600" data-valencia="${val}">${val}</button>`
                    ).join('');
                    contenidoFormulario += `
                        <div class="mb-4">
                            <label class="block text-gray-300 mb-2">Valencias:</label>
                            <div id="valencia-buttons" class="flex flex-wrap justify-center gap-1">${valenciasButtonsHTML}</div>
                        </div>
                    `;
                }

                if (camposPreguntados > 0) {
                    contenidoFormulario += `<button type="button" id="btn-enviar" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-4 transition-colors shadow-lg">Enviar</button>`;
                } else {
                    contenidoFormulario = `<p class="text-yellow-400 mb-3">No has seleccionado ninguna opci√≥n para preguntar en la configuraci√≥n. Por favor, reinicia el juego y configura qu√© aspectos deseas practicar.</p><button id="reiniciar-quiz-cfg" class="bg-cyan-600 hover:bg-cyan-700 text-white py-2 px-4 rounded">Reconfigurar</button>`;
                }

            } else { // Juego de preguntas normal
                contenidoFormulario = `
                    <form id="formulario-pregunta" class="w-full">
                        <label class="block text-gray-300 mb-2 text-left">Respuesta:</label>
                        <input type="text" name="traduccion" class="w-full bg-gray-900 border border-gray-600 rounded p-3 text-white text-lg focus:ring-2 focus:ring-blue-500 outline-none mb-4" placeholder="Escribe tu respuesta aqu√≠" autofocus autocomplete="off">
                        <button type="button" id="btn-enviar" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-lg">Enviar</button>
                    </form>
                `;
            }
            
            let card = $(`
                <div class="card bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 w-full max-w-lg mx-auto mt-6" id="seccion-pregunta">
                    <h3 class="text-2xl font-bold mb-6 text-white text-center">${prefijoPregunta} <span class="text-blue-400">${palabra.nombre}</span>${sufijoPregunta}</h3>
                    ${contenidoFormulario}
                </div>
            `);
            
            // Insertamos la nueva pregunta despu√©s del resultado si existe, o al principio si no existe
            if ($('#seccion-resultado').length) {
                $('#seccion-resultado').after(card);
            } else {
                $('#contenedor').prepend(card); // Prepend para que la pregunta aparezca antes del resultado
            }

            // Establecer el foco y eventos seg√∫n el tipo de juego
            if (tipoDeJuegoActual === "tablaPeriodica") {
                $('input[name="simbolo"]').focus();

                $('.columna-btn').on('click', function () {
                    // Update classes for Tailwind (using yellow-500 for active state)
                    $('.columna-btn').removeClass('bg-yellow-500 text-gray-900 font-bold active').addClass('bg-gray-700 text-white');
                    $(this).removeClass('bg-gray-700 text-white').addClass('bg-yellow-500 text-gray-900 font-bold active');
                });

                $('.valencia-btn').on('click', function () {
                    if ($(this).hasClass('active')) {
                         $(this).removeClass('bg-yellow-500 text-gray-900 font-bold active').addClass('bg-gray-700 text-white');
                    } else {
                         $(this).removeClass('bg-gray-700 text-white').addClass('bg-yellow-500 text-gray-900 font-bold active');
                    }
                });
                 // Vincular Enter al input de s√≠mbolo
                $('input[name="simbolo"]').on('keypress', function(event) {
                    if (event.which === 13) {
                        event.preventDefault();
                        manejarRespuestaTablaPeriodica(palabra);
                    }
                });
                 $('#btn-enviar').on('click', () => manejarRespuestaTablaPeriodica(palabra));


            } else {
                $('#formulario-pregunta input[name="traduccion"]').focus();
                 // Vincular el evento Enter al input
                $('#formulario-pregunta input[name="traduccion"]').on('keypress', function(event) {
                    if (event.which === 13) {
                        event.preventDefault();
                        let traduccionRespuesta = ($('#formulario-pregunta input[name="traduccion"]').val() || '').trim();
                        verificarRespuesta(palabra, traduccionRespuesta);
                    }
                });
                 $('#btn-enviar').on('click', () => {
                    let traduccionRespuesta = ($('#formulario-pregunta input[name="traduccion"]').val() || '').trim();
                    verificarRespuesta(palabra, traduccionRespuesta);
                });
            }
        }

        function manejarRespuestaTablaPeriodica(elemento) {
            let respuestaUsuario = {};

            if (configActualTablaPeriodica.preguntarColumna) {
                respuestaUsuario.columna = $('.columna-btn.active').data('columna') || "";
            }
            if (configActualTablaPeriodica.preguntarSimbolo) {
                respuestaUsuario.simbolo = $('input[name="simbolo"]').val().trim() || "";
            }
            if (configActualTablaPeriodica.preguntarValencias) {
                respuestaUsuario.valencias = $('.valencia-btn.active').map(function() {
                    return $(this).data('valencia').toString();
                }).get();
            }
            verificarRespuesta(elemento, respuestaUsuario);
        }

        function verificarRespuesta(palabra, respuestaUsuario) {
            let mensaje = '';
            let aciertosParciales = 0;
            let esCorrectoGlobal = false;
            let totalCamposPreguntados = 0;

            if (tipoDeJuegoActual === "tablaPeriodica") {
                const elemento = palabra; // alias
                const { columna: colRes, simbolo: simRes, valencias: valRes } = respuestaUsuario;

                mensaje = `Resultados para <strong class="text-white">${elemento.nombre}</strong> <span class="text-gray-400 text-sm">(S√≠mbolo: ${elemento.simbolo}, Columna: ${elemento.columna}, Valencias: ${elemento.valenciasOriginales || elemento.valencias})</span>:<br/><div class="mt-2 space-y-1">`;

                // Contar cu√°ntos campos se est√°n preguntando realmente
                if (configActualTablaPeriodica.preguntarSimbolo) totalCamposPreguntados++;
                if (configActualTablaPeriodica.preguntarColumna) totalCamposPreguntados++;
                if (configActualTablaPeriodica.preguntarValencias) totalCamposPreguntados++;

                if (totalCamposPreguntados === 0) {
                    // Esto no deber√≠a ocurrir si mostrarFormulario lo manej√≥ bien, pero como fallback:
                    mensaje = "No se configur√≥ ninguna pregunta para este elemento.";
                    // No se suma a totalPreguntas ni aciertos, se recarga la pregunta o se finaliza.
                    setTimeout(() => {
                        if (totalPreguntas >= numeroTotalPreguntas) {
                            $('#seccion-pregunta').remove();
                            mostrarResultadosFinales();
                        } else {
                            // No actualizar t√≠tulo aqu√≠, ya que esta pregunta no cont√≥
                            iniciarQuiz(); 
                        }
                    }, 1500);
                    return; // Salir de la funci√≥n de verificaci√≥n
                }

                let puntosPorCampo = 1 / totalCamposPreguntados;

                // Verificar S√≠mbolo (si aplica)
                if (configActualTablaPeriodica.preguntarSimbolo) {
                    if (simRes && simRes.trim().toLowerCase() === elemento.simbolo.trim().toLowerCase()) {
                        aciertosParciales += puntosPorCampo;
                        mensaje += `<div>S√≠mbolo: <span class="text-green-400 font-bold">‚úÖ ${simRes} (Correcto)</span></div>`;
                    } else {
                        mensaje += `<div>S√≠mbolo: <span class="text-red-400 font-bold">‚ùå ${simRes || '(sin respuesta)'} (Incorrecto)</span>. <span class="text-gray-400">Correcto: <span class="text-green-400">${elemento.simbolo}</span></span></div>`;
                    }
                }

                // Verificar Columna (si aplica)
                if (configActualTablaPeriodica.preguntarColumna) {
                    if (colRes && colRes.trim().toLowerCase() === elemento.columna.trim().toLowerCase()) {
                        aciertosParciales += puntosPorCampo;
                        mensaje += `<div>Columna: <span class="text-green-400 font-bold">‚úÖ ${colRes} (Correcto)</span></div>`;
                    } else {
                        mensaje += `<div>Columna: <span class="text-red-400 font-bold">‚ùå ${colRes || '(sin respuesta)'} (Incorrecto)</span>. <span class="text-gray-400">Correcto: <span class="text-green-400">${elemento.columna}</span></span></div>`;
                    }
                }

                // Verificar Valencias (si aplica)
                if (configActualTablaPeriodica.preguntarValencias) {
                    const valenciasCorrectasElemento = (configActualTablaPeriodica.preguntarValenciasComoSimbolo 
                                                    ? elemento.valenciasOriginales 
                                                    : elemento.valencias).split(' ').map(v => v.toString());
                    
                    const valenciasUsuarioArray = Array.isArray(valRes) ? valRes : (valRes ? [valRes.toString()] : []);

                    const todasSeleccionadasCorrectas = valenciasUsuarioArray.length === valenciasCorrectasElemento.length && valenciasUsuarioArray.every(v => valenciasCorrectasElemento.includes(v));
                    const todasCorrectasSeleccionadas = valenciasCorrectasElemento.every(v => valenciasUsuarioArray.includes(v));

                    if (todasSeleccionadasCorrectas && todasCorrectasSeleccionadas) {
                        aciertosParciales += puntosPorCampo;
                        mensaje += `<div>Valencias: <span class="text-green-400 font-bold">‚úÖ ${valenciasUsuarioArray.join(', ') || '(ninguna)'} (Correcto)</span></div>`;
                    } else {
                        mensaje += `<div>Valencias: <span class="text-red-400 font-bold">‚ùå ${valenciasUsuarioArray.join(', ') || '(ninguna)'} (Incorrecto)</span>. <span class="text-gray-400">Correctas: <span class="text-green-400">${valenciasCorrectasElemento.join(', ')}</span></span></div>`;
                    }
                }
                mensaje += "</div>";
                esCorrectoGlobal = (Math.abs(aciertosParciales - 1) < 0.001); // Sigue siendo correcto global si todos los campos preguntados son correctos

            } else { // Juego de preguntas normal
                mensaje = `Resultados para "<span class="font-bold text-blue-300">${palabra.nombre}</span>":<div class="mt-2">`;
                let respuestaNormal = respuestaUsuario || ''; // Asegurar que no sea undefined
                if (typeof respuestaNormal !== 'string') { // Si por error llega algo que no es string
                     respuestaNormal = String(respuestaNormal);
                }
                respuestaNormal = respuestaNormal.trim(); // Eliminar espacios al inicio y al final

                if (esCaseSensitive) {
                    if (respuestaNormal === palabra.respuesta.trim()) {
                        mensaje += `<span class="text-green-400 font-bold text-lg">‚úÖ ¬°Correcto! ${palabra.respuesta}</span>`;
                        esCorrectoGlobal = true;
                    } else {
                        mensaje += `<div class="text-red-400 font-bold mb-1">‚ùå Incorrecto: ${respuestaNormal || '(sin respuesta)'}</div><div class="text-gray-400">La respuesta correcta es <span class="text-green-400 font-bold">${palabra.respuesta}</span>.</div>`;
                    }
                } else {
                    if (respuestaNormal.toLowerCase() === palabra.respuesta.trim().toLowerCase()) {
                        mensaje += `<span class="text-green-400 font-bold text-lg">‚úÖ ¬°Correcto! ${palabra.respuesta}</span>`;
                        esCorrectoGlobal = true;
                    } else {
                        mensaje += `<div class="text-red-400 font-bold mb-1">‚ùå Incorrecto: ${respuestaNormal || '(sin respuesta)'}</div><div class="text-gray-400">La respuesta correcta es <span class="text-green-400 font-bold">${palabra.respuesta}</span>.</div>`;
                    }
                }
                mensaje += "</div>";
            }

            totalPreguntas++;
            if (esCorrectoGlobal) {
                aciertosTotales++;
            }

            // Actualizar estad√≠sticas
            let resultadosGuardados = cargarResultados();
            let resultadoPalabra = resultadosGuardados.find(r => r.palabra === palabra.nombre);
            let estadisticas = {
                preguntas: resultadoPalabra ? resultadoPalabra.preguntas + 1 : 1,
                aciertos: resultadoPalabra ? resultadoPalabra.aciertos : 0
            };
            if (esCorrectoGlobal) {
                estadisticas.aciertos++;
            }
            
            let nuevoResultado = {
                palabra: palabra.nombre,
                respuestaDada: (tipoDeJuegoActual === "tablaPeriodica") ? JSON.stringify(respuestaUsuario) : (respuestaUsuario || ''),
                correcto: esCorrectoGlobal,
                aciertosParciales: (tipoDeJuegoActual === "tablaPeriodica") ? aciertosParciales.toFixed(2) : undefined,
                preguntas: estadisticas.preguntas,
                aciertos: estadisticas.aciertos,
                porcentaje: (estadisticas.aciertos / estadisticas.preguntas) * 100,
                ultimaVez: new Date().toLocaleString()
            };

            let index = resultadosGuardados.findIndex(r => r.palabra === palabra.nombre);
            if (index !== -1) {
                resultadosGuardados[index] = nuevoResultado;
            } else {
                resultadosGuardados.push(nuevoResultado);
            }
            guardarResultados(resultadosGuardados);
            resultados = resultadosGuardados; // Actualizar la variable global de resultados

            mensaje += `<div class="mt-4 pt-3 border-t border-gray-700 text-sm text-gray-400">üéØ Puntos Totales: <span class="text-white font-bold">${aciertosTotales} / ${totalPreguntas}</span></div>`;

            $('#seccion-resultado').remove();
            let resultadoCard = $(`
                <div class="card bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-6 w-full max-w-lg mx-auto mb-6" id="seccion-resultado">
                    <div class="text-lg">${mensaje}</div>
                </div>
            `);
            // Insertar el resultado antes de la pregunta si la pregunta a√∫n existe, sino al final del contenedor
            if ($('#seccion-pregunta').length) {
                 $('#seccion-pregunta').before(resultadoCard);
            } else {
                 $('#contenedor').append(resultadoCard);
            }


            setTimeout(() => {
                if (totalPreguntas >= numeroTotalPreguntas) {
                    $('#seccion-pregunta').remove();
                    mostrarResultadosFinales();
                } else {
                    actualizarTitulo();
                    iniciarQuiz();
                }
            }, tipoDeJuegoActual === "tablaPeriodica" ? 3000 : 2000); // M√°s tiempo para leer resultados de tabla peri√≥dica
        }
        
        function mostrarResultadosFinales() {
            let nota = (aciertosTotales / numeroTotalPreguntas) * 100; // Calcular nota
            
            const inicioSlice = Math.max(0, resultados.length - numeroTotalPreguntas);
            const resultadosSesionActual = resultados.slice(inicioSlice);

            let resumenPreguntas = resultadosSesionActual
                .map(r => {
                    let preguntaTexto = r.palabra;
                    let respuestaDadaTexto = '';
                    let resultadoTexto = '';
                    
                    // Asegurarse de que r.respuestaDada es string antes de JSON.parse o usar directamente
                    let rawRespuestaDada = r.respuestaDada;
                    if (typeof rawRespuestaDada !== 'string') {
                        rawRespuestaDada = String(rawRespuestaDada); // Convertir a string si no lo es
                    }


                    if (tipoDeJuegoActual === "tablaPeriodica") {
                        const elemento = preguntasJSON.find(p => p.nombre === r.palabra);
                        if (!elemento) return '<tr><td colspan="3" class="p-2">Error: Elemento no encontrado</td></tr>';

                        let detallesRespuestaDada = {};
                        try {
                            // Solo parsear si es un string que parece JSON object
                            if (rawRespuestaDada.startsWith('{') && rawRespuestaDada.endsWith('}')) {
                                detallesRespuestaDada = JSON.parse(rawRespuestaDada);
                            } else if (rawRespuestaDada) { // Si no es JSON, podr√≠a ser un string simple o vac√≠o
                                // No se puede asumir una estructura, as√≠ que se podr√≠a mostrar el string crudo
                                // o intentar deducir. Para este caso, si no es JSON, no se pueden extraer detalles.
                                // Dejamos detallesRespuestaDada como objeto vac√≠o si no se puede parsear.
                            }
                        } catch(e) { 
                            console.error("Error parsing respuestaDada JSON:", e, rawRespuestaDada);
                            // Si falla el parseo, detallesRespuestaDada queda vac√≠o
                        }
                        
                        const valenciasUsuarioTexto = (detallesRespuestaDada.valencias && Array.isArray(detallesRespuestaDada.valencias)) ? detallesRespuestaDada.valencias.join(', ') : (detallesRespuestaDada.valencias || '-');

                        respuestaDadaTexto = `<div class="text-xs">Sim: ${detallesRespuestaDada.simbolo || '-'}<br/>Col: ${detallesRespuestaDada.columna || '-'}<br/>Val: ${valenciasUsuarioTexto}</div>`;
                        
                        const valenciasCorrectasText = (elemento.valenciasOriginales || elemento.valencias).split(' ').join(', ');

                        if (r.correcto) {
                            resultadoTexto = `<span class="text-green-400 font-bold">‚úÖ Correcto</span>`;
                        } else {
                            resultadoTexto = `<span class="text-red-400 font-bold">‚ùå Incorrecto</span><div class="text-xs text-gray-400 mt-1">Sim: ${elemento.simbolo}<br/>Col: ${elemento.columna}<br/>Val: ${valenciasCorrectasText}</div>`;
                        }
                    } else { // Juego de preguntas normal
                        const preguntaOriginal = preguntasJSON.find(p => p.nombre === r.palabra);
                        if (!preguntaOriginal) return '<tr><td colspan="3" class="p-2">Error: Pregunta no encontrada</td></tr>';

                        respuestaDadaTexto = rawRespuestaDada || '<span class="italic text-gray-500">(sin respuesta)</span>'; // Usar el string crudo
                        if (r.correcto) {
                            resultadoTexto = `<span class="text-green-400 font-bold">‚úÖ Correcto</span>`;
                        } else {
                            resultadoTexto = `<span class="text-red-400 font-bold">‚ùå Incorrecto</span> <span class="text-gray-400 text-sm">(${preguntaOriginal.respuesta})</span>`;
                        }
                    }
                    return `
                        <tr class="border-b border-gray-700 hover:bg-gray-700 transition-colors">
                            <td class="p-3 align-top font-medium text-blue-300">${preguntaTexto}</td>
                            <td class="p-3 align-top text-gray-300">${respuestaDadaTexto}</td>
                            <td class="p-3 align-top">${resultadoTexto}</td>
                        </tr>
                    `;
                }).join('');

            let card = $(`
                <div class="card bg-gray-800 border border-gray-700 rounded-xl shadow-2xl w-full max-w-4xl mx-auto my-10">
                    <div class="p-6 md:p-8">
                        <div class="text-center mb-8">
                            <h4 class="text-3xl font-bold text-white mb-2">üèÅ Fin del Quiz</h4>
                            <div class="text-xl text-gray-400">üíØ Nota final: <span class="font-bold ${nota >= 50 ? 'text-green-400' : 'text-red-400'}">${nota.toFixed(2)}%</span> ${nota >= 90 ? 'üéâ' : nota >= 70 ? 'üëç' : nota >= 50 ? 'üòä' : 'üí™'}</div>
                        </div>
                        <div class="overflow-x-auto rounded-lg border border-gray-700 bg-gray-900 mb-8">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-800 text-gray-400 uppercase text-xs tracking-wider">
                                    <tr>
                                        <th class="p-3 font-semibold">Pregunta</th>
                                        <th class="p-3 font-semibold">Tu respuesta</th>
                                        <th class="p-3 font-semibold">Resultado</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                                    ${resumenPreguntas}
                                </tbody>
                            </table>
                        </div>
                        <button id="reiniciar-quiz" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-lg">üîÑ Reiniciar Quiz</button>
                    </div>
                </div>
            `);
            $('#contenedor').append(card);

            $('#reiniciar-quiz').on('click', function () {
                reiniciarJuego();
            });
        }

        function reiniciarJuego() {
            totalPreguntas = 0;
            aciertosTotales = 0;
            palabrasUsadas = [];
            // modoJuego se mantiene o se podr√≠a resetear aqu√≠ si se desea que siempre vuelva a preguntar
            resultados = cargarResultados();
            $('#contenedor').empty(); // Limpiar el contenedor
            preguntarNombre(); // Volver a preguntar el nombre y mostrar configuraci√≥n
        }

        function mostrarAjustesUsuario() {
            const modal = $(`
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4" id="modal-ajustes">
                    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" id="modal-ajustes-backdrop"></div>
                    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md z-10 border border-gray-700 transform transition-all">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-bold text-white">Ajustes de Usuario</h3>
                                <button type="button" class="text-gray-400 hover:text-white transition-colors text-2xl leading-none focus:outline-none" id="cerrar-ajustes">
                                    &times;
                                </button>
                            </div>
                            
                            <div class="mb-6">
                                <label class="block text-gray-300 mb-2 font-medium">Nombre de usuario:</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="input-cambiar-nombre" class="flex-1 bg-gray-900 border border-gray-600 rounded-lg p-3 text-white text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Tu nombre">
                                    <button id="btn-guardar-nombre" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                                        Guardar
                                    </button>
                                </div>
                            </div>
                            
                            <div class="pt-4 border-t border-gray-700">
                                <button type="button" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md" id="btn-cerrar-ajustes">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            $('body').append(modal);
            $('#input-cambiar-nombre').val(usuarioActual || '').focus().select();
            
            const cerrarModal = () => {
                $('#modal-ajustes').fadeOut(200, function() { $(this).remove(); });
            };
            
            $('#btn-guardar-nombre').on('click', function() {
                const nuevoNombre = $('#input-cambiar-nombre').val().trim();
                if (nuevoNombre && nuevoNombre !== usuarioActual) {
                    usuarioActual = nuevoNombre;
                    setCookie('usuarioActual', usuarioActual);
                    actualizarNombreUsuario();
                    cerrarModal();
                } else if (!nuevoNombre) {
                    $('#input-cambiar-nombre').addClass('border-red-500');
                    setTimeout(() => $('#input-cambiar-nombre').removeClass('border-red-500'), 1000);
                } else {
                    cerrarModal();
                }
            });
            
            $('#input-cambiar-nombre').on('keypress', function(e) {
                if (e.which === 13) {
                    $('#btn-guardar-nombre').click();
                }
            });
            
            $('#cerrar-ajustes, #btn-cerrar-ajustes, #modal-ajustes-backdrop').on('click', cerrarModal);
        }

        function mostrarEstadisticas() {
            const resultadosGuardados = cargarResultados();
            let resultadosAgrupados = {};
            
            resultadosGuardados.forEach(r => {
                if (!resultadosAgrupados[r.palabra]) {
                    resultadosAgrupados[r.palabra] = {
                        preguntas: r.preguntas,
                        aciertos: r.aciertos,
                        porcentaje: r.porcentaje,
                        ultimaVez: r.ultimaVez
                    };
                } else {
                    resultadosAgrupados[r.palabra].preguntas = r.preguntas;
                    resultadosAgrupados[r.palabra].aciertos = r.aciertos;
                    resultadosAgrupados[r.palabra].porcentaje = r.porcentaje;
                    resultadosAgrupados[r.palabra].ultimaVez = r.ultimaVez;
                }
            });

            let resultadosHTML = `
                <div class="overflow-x-auto rounded-lg border border-gray-600 bg-gray-900 max-h-[60vh] overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-800 text-gray-400 uppercase text-xs tracking-wider sticky top-0">
                            <tr>
                                <th class="p-3 font-semibold">Pregunta</th>
                                <th class="p-3 font-semibold text-center">Veces</th>
                                <th class="p-3 font-semibold text-center">Aciertos</th>
                                <th class="p-3 font-semibold text-center">%</th>
                                <th class="p-3 font-semibold">√öltima vez</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${Object.entries(resultadosAgrupados)
                                .sort(([palabraA], [palabraB]) => palabraA.localeCompare(palabraB))
                                .map(([palabra, stats]) => {
                                const colorClass = stats.porcentaje >= 85 ? 'text-green-400' : (stats.porcentaje >= 50 ? 'text-yellow-400' : 'text-red-400');
                                const emoji = stats.porcentaje >= 85 ? 'üèÜ' : (stats.porcentaje >= 50 ? 'üëç' : 'üí™');
                                return `
                                    <tr class="hover:bg-gray-800">
                                        <td class="p-3 font-medium text-gray-200">${palabra}</td>
                                        <td class="p-3 text-center text-gray-400">${stats.preguntas}</td>
                                        <td class="p-3 text-center text-gray-400">‚úÖ ${stats.aciertos}</td>
                                        <td class="p-3 text-center font-bold ${colorClass}">${emoji} ${stats.porcentaje.toFixed(2)}%</td>
                                        <td class="p-3 text-sm text-gray-500">${stats.ultimaVez || 'N/A'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            let modal = $(`
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4" id="modal-estadisticas">
                    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" id="modal-backdrop"></div>
                    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl z-10 flex flex-col max-h-[90vh] border border-gray-700 transform transition-all scale-100">
                        <div class="p-5 border-b border-gray-700 flex justify-between items-center">
                            <h5 class="text-xl font-bold text-white">üìä Estad√≠sticas de ${juegoActual}</h5>
                            <button type="button" class="text-gray-400 hover:text-white transition-colors text-2xl leading-none focus:outline-none" id="close-modal">
                                &times;
                            </button>
                        </div>
                        <div class="p-6 overflow-hidden flex-1">
                            ${resultadosHTML}
                        </div>
                        <div class="p-5 border-t border-gray-700 flex justify-between">
                            <button id="borrar-estadisticas" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-md">Borrar Todo</button>
                            <button type="button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded transition-colors shadow-md" id="btn-cerrar-modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            `);
            
            $('body').append(modal);
            // Simple animation for showing
            $('#modal-backdrop').hide().fadeIn(200);

            const closeModal = () => {
                 $('#modal-estadisticas').fadeOut(200, function() { $(this).remove(); });
            };

            $('#close-modal, #btn-cerrar-modal, #modal-backdrop').on('click', closeModal);

            $('#borrar-estadisticas').on('click', function () {
                if(confirm("¬øEst√°s seguro de que quieres borrar todas las estad√≠sticas de este juego?")) {
                    const claveStorage = `resultados_${juegoActual}`;
                    localStorage.removeItem(claveStorage);
                    resultados = [];
                    closeModal();
                }
            });
        }

        window.onload = function() {
            cargarJuego()
                .then(() => {
                    resultados = cargarResultados();
                    preguntarNombre();
                    $('#ver-estadisticas').on('click', function() {
                        mostrarEstadisticas();
                    });
                    $('#btn-usuario').on('click', function() {
                        mostrarAjustesUsuario();
                    });
                    // Actualizar el nombre en el bot√≥n si ya existe
                    if (usuarioActual) {
                        $('#nombre-usuario-display').text(usuarioActual);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar el juego:', error);
                    alert('Error al cargar el juego: ' + error.message);
                    window.location.href = 'index.html';
                });
        };
    </script>
</head>

<body class="bg-gray-900 text-white min-h-screen font-sans flex flex-col p-4">
    <a href="index.html" class="fixed top-4 left-4 z-40 bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-full shadow-lg border border-gray-600 transition-colors flex items-center justify-center group" title="Volver al Inicio">
        <i class="fas fa-home text-lg group-hover:scale-110 transition-transform"></i>
    </a>
    
    <button id="btn-usuario" class="fixed top-4 right-4 z-40 bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow-lg border border-gray-600 transition-colors flex items-center space-x-2 group" title="Ajustes de usuario">
        <i class="fas fa-user text-lg"></i>
        <span id="nombre-usuario-display">Usuario</span>
    </button>
    
    <div class="container mx-auto max-w-2xl flex-grow flex flex-col items-center justify-start pt-16">
        <header class="text-center mb-6 w-full">
            <h1 id="titulo" class="text-3xl font-bold text-blue-400 mb-2"></h1>
            <div id="descripcion" class="text-gray-400 text-sm"></div>
        </header>

        <div id="contenedor" class="w-full flex flex-col items-center">
            <!-- Aqu√≠ se insertar√°n din√°micamente la pregunta y el resultado -->
        </div>
    </div>

    <footer class="w-full text-center py-6 mt-auto">
        <button id="ver-estadisticas" class="text-gray-400 hover:text-white underline text-sm transition-colors">üìä Ver Estad√≠sticas</button>
    </footer>
</body>

</html>